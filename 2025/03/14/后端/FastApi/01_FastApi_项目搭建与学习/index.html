<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>01_FastApi_项目搭建与学习 | 春和景明的记事本</title><meta name="author" content="Scenery"><meta name="copyright" content="Scenery"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="项目基础构建1 依赖项123456789101112fastapi[all]&amp;#x3D;&amp;#x3D;0.75.2  aioredis&amp;#x3D;&amp;#x3D;2.0.1  cos-python-sdk-v5&amp;#x3D;&amp;#x3D;1.9.15  PyJWT&amp;#x3D;&amp;#x3D;2.3.0  python-dotenv&amp;#x3D;&amp;#x3D;0.19.1  tortoise-orm[aiomysql"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://vernalscenery.github.io/2025/03/14/%E5%90%8E%E7%AB%AF/FastApi/01_FastApi_%E9%A1%B9%E7%9B%AE%E6%90%AD%E5%BB%BA%E4%B8%8E%E5%AD%A6%E4%B9%A0/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '01_FastApi_项目搭建与学习',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-08-05 14:17:12'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="Hexo 5.4.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/./img/1.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">73</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/./img/1.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="春和景明的记事本"><span class="site-name">春和景明的记事本</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">01_FastApi_项目搭建与学习</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-03-14T00:24:34.000Z" title="发表于 2025-03-14 08:24:34">2025-03-14</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-08-05T06:17:12.000Z" title="更新于 2025-08-05 14:17:12">2025-08-05</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">16.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>70分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="01_FastApi_项目搭建与学习"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="项目基础构建"><a href="#项目基础构建" class="headerlink" title="项目基础构建"></a>项目基础构建</h1><h2 id="1-依赖项"><a href="#1-依赖项" class="headerlink" title="1 依赖项"></a>1 依赖项</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">fastapi[all]==0.75.2  </span><br><span class="line">aioredis==2.0.1  </span><br><span class="line">cos-python-sdk-v5==1.9.15  </span><br><span class="line">PyJWT==2.3.0  </span><br><span class="line">python-dotenv==0.19.1  </span><br><span class="line">tortoise-orm[aiomysql]==0.19.0  </span><br><span class="line">tencentcloud-sdk-python==3.0.618  </span><br><span class="line">wechatpy==2.0.0a11  </span><br><span class="line">qrcode[pil]==7.3.1  </span><br><span class="line">python-alipay-sdk==3.0.4  </span><br><span class="line">passlib==1.7.4  </span><br><span class="line">sqlmodel==0.0.6</span><br></pre></td></tr></table></figure>

<h2 id="2-常用命令"><a href="#2-常用命令" class="headerlink" title="2 常用命令"></a>2 常用命令</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建虚拟环境</span></span><br><span class="line">conda create --name fatsapi_learn python=<span class="number">3.8</span></span><br><span class="line"><span class="comment"># 删除虚拟环境</span></span><br><span class="line">conda remove -n fatsapi_learn --<span class="built_in">all</span></span><br><span class="line"><span class="comment"># 激活虚拟环境</span></span><br><span class="line">conda activate fastapi_learn</span><br><span class="line"></span><br><span class="line"><span class="comment"># 升级pip</span></span><br><span class="line">pip install --upgrade pip</span><br><span class="line"><span class="comment"># 升级pip到指定版本</span></span><br><span class="line">python -m pip install --upgrade pip==<span class="number">23.2</span><span class="number">.1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 依据requirements.txt下载依赖</span></span><br><span class="line">pip install -r .\requirements.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看fastapi版本</span></span><br><span class="line">fastapi --version</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动fastapi</span></span><br><span class="line">uvicorn app:app</span><br><span class="line"></span><br><span class="line"><span class="comment"># 热启动fastapi</span></span><br><span class="line">uvicorn app:app --port <span class="number">8080</span> --reload</span><br></pre></td></tr></table></figure>

<h1 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h1><h2 id="1-官网介绍"><a href="#1-官网介绍" class="headerlink" title="1 官网介绍"></a>1 官网介绍</h2><p>官网 <a target="_blank" rel="noopener" href="https://fastapi.tiangolo.com/zh/">FastAPI</a></p>
<p><img src="https://picgocloud.oss-cn-shanghai.aliyuncs.com/picgo/20250314202827.png" alt="image.png"></p>
<ul>
<li>​<strong>Starlette 管“流程”​</strong>：负责请求生命周期管理、网络协议交互</li>
<li>​<strong>Pydantic 管“数据”​</strong>：通过类型提示实现请求体/响应体的自动校验与序列化</li>
</ul>
<ol>
<li>​<strong>客户端请求</strong> → 2. ​<strong>Uvicorn 接收并解析</strong> → 3. ​<strong>ASGI 协议传递至 FastAPI</strong></li>
<li>​<strong>Pydantic 数据校验</strong> → 5. ​<strong>业务逻辑处理</strong> → 6. ​<strong>响应序列化返回</strong></li>
</ol>
<h2 id="2-ASGI-和-Uvicorn"><a href="#2-ASGI-和-Uvicorn" class="headerlink" title="2 ASGI 和 Uvicorn"></a>2 ASGI 和 Uvicorn</h2><table>
<thead>
<tr>
<th>​<strong>组件</strong></th>
<th>​<strong>职责</strong></th>
<th>​<strong>技术实现</strong></th>
<th>​<strong>性能优势</strong></th>
</tr>
</thead>
<tbody><tr>
<td>​<strong>ASGI</strong></td>
<td>定义应用与服务器通信标准</td>
<td>异步协议支持、生命周期管理</td>
<td>支持高并发和实时通信</td>
</tr>
<tr>
<td>​<strong>Uvicorn</strong></td>
<td>实现 ASGI 标准，处理网络 I/O</td>
<td>uvloop 事件循环、httptools 解析器</td>
<td>单核吞吐量达 5 万+ QPS，延迟低至 18ms</td>
</tr>
</tbody></table>
<p>ASGI（异步服务器网关接口）是 Python 异步 Web 应用的<strong>标准化接口</strong>，作为 WSGI 的演进版本，专为支持异步协议和现代 Web 需求设计。其核心价值在于突破 WSGI 的同步处理限制，支持 HTTP/2、WebSocket、长轮询等异步通信协议，并允许单进程同时处理数千个连接，显著提升高并发场景下的吞吐量。</p>
<p><strong>Uvicorn 作为 ASGI 标准的实现</strong>，通过底层优化实现卓越性能：</p>
<ol>
<li><strong>架构优势</strong>：基于 uvloop（替代 asyncio 事件循环）和 httptools（高效 HTTP 解析器），其事件循环性能接近 Go 语言水平，HTTP 请求处理速度比传统服务器提升 5-10 倍</li>
<li><strong>协议支持</strong>：完整支持 HTTP/1.1 与 WebSocket 协议，适用于实时通信场景如在线聊天、游戏服务端</li>
<li><strong>开发适配</strong>：无缝兼容 FastAPI、Starlette 等异步框架，通过<code>uvicorn.run()</code>命令或代码集成即可启动服务，支持热重载 (–reload) 和调试模式 (–debug)</li>
<li><strong>生产部署</strong>：支持多进程工作模式 (–workers)，可与 Gunicorn 协同部署，通过 Gunicorn 作为进程管理器实现负载均衡和零停机更新</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动FastAPI应用（开发环境）</span></span><br><span class="line">uvicorn main:app --reload --port <span class="number">8000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生产环境多进程部署</span></span><br><span class="line">uvicorn.run(<span class="string">&quot;app:asgi_server&quot;</span>, workers=<span class="number">4</span>, log_level=<span class="string">&quot;info&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>在 FastAPI 技术栈中，ASGI 规范定义了框架与服务器的通信标准，Uvicorn 则作为运行时引擎，两者协同工作形成高性能 Web 服务的基石。这种组合使 Python 在 IO 密集型应用中达到与 Node.js、Go 等语言同级别的性能表现。</p>
<h2 id="3-Starlette"><a href="#3-Starlette" class="headerlink" title="3 Starlette"></a>3 Starlette</h2><h3 id="3-1-Starlette-核心功能与定位"><a href="#3-1-Starlette-核心功能与定位" class="headerlink" title="3.1 Starlette 核心功能与定位"></a>3.1 Starlette 核心功能与定位</h3><ul>
<li><p><strong>异步请求处理引擎</strong>：Starlette 基于 <code>asyncio</code> 实现了非阻塞 I/O 模型，支持每秒数万级并发请求。通过事件循环机制，它在处理数据库查询、文件读写等 I/O 密集型操作时，无需等待任务完成即可切换执行其他任务，显著提升吞吐量</p>
</li>
<li><p><strong>基础组件提供者</strong>：提供路由系统、中间件、WebSocket 支持等核心功能</p>
<ul>
<li>​<strong>路由管理</strong>：支持路径参数、查询参数、请求方法映射（如 <code>@app.get(&quot;/users/&#123;user_id&#125;&quot;)</code></li>
<li><strong>中间件扩展</strong>：可添加跨域处理（CORS）、认证拦截、日志记录等全局逻辑（如 <code>CORSMiddleware</code>）</li>
<li><strong>协议支持</strong>：原生兼容 HTTP/HTTPS、WebSocket、Server-Sent Events（SSE）等协议</li>
</ul>
</li>
<li><p><strong>ASGI 标准实现者</strong>：作为 WSGI 的异步替代方案，ASGI 允许 <code>Starlette</code> 与 <code>Uvicorn</code>、<code>Hypercorn</code> 等高性能服务器无缝集成，解决传统同步框架（如 Flask）的阻塞问题</p>
</li>
</ul>
<h3 id="3-2-Starlette-在-FastAPI-中的核心作用"><a href="#3-2-Starlette-在-FastAPI-中的核心作用" class="headerlink" title="3.2 Starlette 在 FastAPI 中的核心作用"></a>3.2 Starlette 在 FastAPI 中的核心作用</h3><ul>
<li><p><strong>底层通信架构</strong>：FastAPI 直接继承 Starlette 的 <code>Router</code>、<code>Request</code>、<code>Response</code> 等类，由 Starlette 完成 HTTP 报文解析、路由分发、响应生成等底层通信。例如 FastAPI 的 <code>@app.get()</code> 装饰器实际调用 Starlette 的路由注册逻辑</p>
</li>
<li><p><strong>异步能力提供者</strong>：FastAPI 的 <code>async/await</code> 异步接口依赖于 Starlette 的异步执行环境。例如处理数据库查询时，FastAPI 可挂起当前协程，释放 CPU 资源处理其他请求，避免线程阻塞</p>
</li>
<li><p><strong>扩展功能基石</strong></p>
<ul>
<li><strong>中间件集成</strong>：FastAPI 通过 Starlette 的中间件系统实现依赖注入（如 <code>Depends(get_db)</code>）、JWT 认证等功能</li>
<li>​<strong>WebSocket 支持</strong>：FastAPI 的 <code>WebSocketEndpoint</code> 直接基于 Starlette 的 <code>WebSocketRoute</code> 开发，用于实时通信场景</li>
<li><strong>静态文件服务</strong>：通过 Starlette 的 <code>StaticFiles</code> 组件提供文件下载服务（如 <code>FileResponse</code>）</li>
</ul>
</li>
<li><p><strong>性能优化核心</strong>：Starlette 的轻量化设计（无冗余依赖）使 FastAPI 的基准测试性能比 Flask 快 6 倍以上</p>
</li>
</ul>
<h2 id="4-Pydantic"><a href="#4-Pydantic" class="headerlink" title="4 Pydantic"></a>4 Pydantic</h2><h3 id="4-1-简介"><a href="#4-1-简介" class="headerlink" title="4.1 简介"></a>4.1 简介</h3><p><strong>Pydantic</strong> 是基于类型提示实现的高效数据校验与序列化库，其核心机制是<strong>通过解析类型注解来自动验证数据结构</strong>。</p>
<p>例如，定义继承自<code>BaseModel</code>的数据模型时，字段类型若标注为<code>str</code>，Pydantic 会强制校验输入数据是否符合字符串格式，并在校验失败时抛出结构化错误信息。</p>
<p>此外，它支持 JSON Schema 生成，可直接用于 API 文档的自动化构建（如 Swagger），同时提供数据解析、配置管理等功能，成为 FastAPI 等框架默认集成的数据层解决方案。</p>
<p><strong>BaseModel</strong> 是 Pydantic 库的核心组件，用于定义数据模型的结构和验证规则。通过继承 BaseModel 创建的类能够自动实现类型校验、数据转换和错误处理功能。</p>
<p><span style="color: #badc58; font-weight: 550;">核心特性：</span></p>
<ol>
<li><strong>自动类型转换</strong>：处理外部输入时自动进行类型转换（如字符串→整型、时间解析）。</li>
<li><strong>数据校验</strong>：强制类型约束，支持自定义校验规则（如字符串长度限制<code>constr</code>）。</li>
<li><strong>ORM 集成</strong>：通过<code>orm_mode</code>实现数据库模型与 Pydantic 模型的无缝转换。</li>
<li><strong>错误处理</strong>：结构化错误输出明确标识无效字段及原因。</li>
<li><strong>复杂结构支持</strong>：嵌套模型、递归模型、列表 / 可选字段等高级数据结构验证。</li>
<li><strong>序列化能力</strong>：内置方法快速转换为字典 / JSON，支持文件读写操作。</li>
</ol>
<h3 id="4-2-Pydantic-基础模型"><a href="#4-2-Pydantic-基础模型" class="headerlink" title="4.2 Pydantic 基础模型"></a>4.2 Pydantic 基础模型</h3><p>User 继承 Pydantic 的核心组件 BaseModel </p>
<p>故当其实例化时能够自动实现类型校验</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, date</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Optional</span></span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, ValidationError, constr  <span class="comment"># Pydantic核心组件</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="built_in">id</span>: <span class="built_in">int</span>  <span class="comment"># 必填字段（无默认值），Pydantic会自动将字符串&quot;123&quot;转换为整数</span></span><br><span class="line">    name: <span class="built_in">str</span> = <span class="string">&quot;John Snow&quot;</span>  <span class="comment"># 可选字段（带默认值）</span></span><br><span class="line">    signup_ts: <span class="type">Optional</span>[datetime] = <span class="literal">None</span>  <span class="comment"># 支持时间类型自动转换（字符串→datetime对象）</span></span><br><span class="line">    friends: <span class="type">List</span>[<span class="built_in">int</span>] = []  <span class="comment"># 列表元素自动类型转换（如字符串&quot;3&quot;→整数3）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据验证与转换示例</span></span><br><span class="line">external_data = &#123;</span><br><span class="line">    <span class="string">&quot;id&quot;</span>: <span class="string">&quot;123&quot;</span>,  <span class="comment"># 字符串将被转换为整型</span></span><br><span class="line">    <span class="string">&quot;signup_ts&quot;</span>: <span class="string">&quot;2020-12-22 12:22&quot;</span>,  <span class="comment"># 时间字符串自动解析为datetime对象</span></span><br><span class="line">    <span class="string">&quot;friends&quot;</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="string">&quot;3&quot;</span>]  <span class="comment"># 混合类型列表统一转换为整型列表</span></span><br><span class="line">&#125;</span><br><span class="line">user = User(**external_data)  <span class="comment"># 实例化时自动执行数据校验与类型转换</span></span><br><span class="line"><span class="built_in">print</span>(user.<span class="built_in">id</span>, user.friends)  <span class="comment"># 实例化后调用属性  </span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">repr</span>(user.signup_ts))   <span class="comment"># 输出 `datetime` 对象的构造细节</span></span><br><span class="line"><span class="built_in">print</span>(user.<span class="built_in">dict</span>())</span><br></pre></td></tr></table></figure>

<p>结果如下：</p>
<p><img src="https://picgocloud.oss-cn-shanghai.aliyuncs.com/picgo/20250314204307.png" alt="image.png"></p>
<h3 id="4-3-校验异常处理"><a href="#4-3-校验异常处理" class="headerlink" title="4.3 校验异常处理"></a>4.3 校验异常处理</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># 触发校验错误：friends列表包含无法转换为整型的字符串</span></span><br><span class="line">    User(<span class="built_in">id</span>=<span class="number">1</span>, signup_ts=datetime.today(), friends=[<span class="number">1</span>, <span class="number">2</span>, <span class="string">&quot;not number&quot;</span>])</span><br><span class="line"><span class="keyword">except</span> ValidationError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(e.json())  <span class="comment"># 输出结构化错误信息（JSON格式），便于定位问题</span></span><br></pre></td></tr></table></figure>

<p><img src="https://picgocloud.oss-cn-shanghai.aliyuncs.com/picgo/20250314204248.png" alt="image.png"></p>
<h3 id="4-4-继承模型方法与属性"><a href="#4-4-继承模型方法与属性" class="headerlink" title="4.4 继承模型方法与属性"></a>4.4 继承模型方法与属性</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(user.<span class="built_in">dict</span>())  <span class="comment"># 将模型实例转换为标准字典（包含所有字段及转换后的数据）</span></span><br><span class="line"><span class="built_in">print</span>(user.json())  <span class="comment"># 序列化为JSON字符串（支持datetime等复杂类型的ISO格式转换）</span></span><br><span class="line"><span class="built_in">print</span>(user.copy())  <span class="comment"># 创建模型实例的浅拷贝</span></span><br><span class="line"><span class="built_in">print</span>(User.parse_obj(external_data))  <span class="comment"># 从字典创建实例（等效于直接实例化）</span></span><br><span class="line"><span class="built_in">print</span>(User.parse_raw(<span class="string">&#x27;&#123;&quot;id&quot;: &quot;123&quot;, ...&#125;&#x27;</span>))  <span class="comment"># 从JSON字符串直接解析</span></span><br><span class="line"></span><br><span class="line">path = Path(<span class="string">&#x27;pydantic_tutorial.json&#x27;</span>)  </span><br><span class="line">path.write_text(<span class="string">&#x27;&#123;&quot;id&quot;: &quot;123&quot;, &quot;signup_ts&quot;: &quot;2020-12-22 12:22&quot;, &quot;friends&quot;: [1, 2, &quot;3&quot;]&#125;&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(User.parse_file(path))  <span class="comment"># 从文件读取数据并解析（需Path对象指向有效JSON文件）</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(user.schema())  <span class="comment"># 打印模型的Schema</span></span><br><span class="line"><span class="built_in">print</span>(user.schema_json())  <span class="comment"># 生成符合JSON Schema规范的模型结构描述</span></span><br><span class="line"></span><br><span class="line">user_data = &#123;<span class="string">&quot;id&quot;</span>: <span class="string">&quot;error&quot;</span>, <span class="string">&quot;signup_ts&quot;</span>: <span class="string">&quot;2020-12-22 12 22&quot;</span>, <span class="string">&quot;friends&quot;</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]&#125;  <span class="comment"># id是字符串 是错误的  </span></span><br><span class="line"><span class="built_in">print</span>(User.construct(**user_data))  <span class="comment"># 不检验数据直接创建模型实例，不建议使用  </span></span><br><span class="line"><span class="built_in">print</span>(User.__fields__.keys())  <span class="comment"># 打印模型类的所有字段名</span></span><br></pre></td></tr></table></figure>

<p><img src="https://picgocloud.oss-cn-shanghai.aliyuncs.com/picgo/20250314204551.png" alt="image.png"></p>
<h3 id="4-5-递归模型嵌套"><a href="#4-5-递归模型嵌套" class="headerlink" title="4.5 递归模型嵌套"></a>4.5 递归模型嵌套</h3><p><code>sound: List[Sound]</code> : 不同的狗有不同的叫声。<strong>递归模型（Recursive Models）就是指一个嵌套一个</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Sound</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    sound: <span class="built_in">str</span>  <span class="comment"># 基础模型定义</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dog</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    birthday: date  <span class="comment"># 日期类型自动转换</span></span><br><span class="line">    weight: <span class="type">Optional</span>[<span class="built_in">float</span>] = <span class="literal">None</span>  <span class="comment"># 可选浮点字段</span></span><br><span class="line">    sound: <span class="type">List</span>[Sound]  <span class="comment"># 嵌套模型列表（递归验证）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 嵌套数据验证示例</span></span><br><span class="line">dogs = Dog(</span><br><span class="line">    birthday=date.today(), </span><br><span class="line">    weight=<span class="number">6.66</span>, </span><br><span class="line">    sound=[&#123;<span class="string">&quot;sound&quot;</span>: <span class="string">&quot;wang wang ~&quot;</span>&#125;, &#123;<span class="string">&quot;sound&quot;</span>: <span class="string">&quot;ying ying ~&quot;</span>&#125;]</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><img src="https://picgocloud.oss-cn-shanghai.aliyuncs.com/picgo/20250314204609.png" alt="image.png"></p>
<h3 id="4-6-ORM-模型集成"><a href="#4-6-ORM-模型集成" class="headerlink" title="4.6 ORM 模型集成"></a>4.6 ORM 模型集成</h3><h4 id="4-6-1-什么是-ORM"><a href="#4-6-1-什么是-ORM" class="headerlink" title="4.6.1 什么是 ORM"></a>4.6.1 什么是 ORM</h4><blockquote>
<p>ORM（Object-Relational Mapping，对象关系映射）是一种编程技术，用于在<strong>面向对象编程语言</strong>与<strong>关系型数据库</strong>之间建立数据映射关系，使开发者能够通过操作编程语言中的对象（而非直接编写SQL语句）来管理数据库。</p>
</blockquote>
<p> ORM 在代码中创建一个<strong>虚拟对象数据库</strong></p>
<ul>
<li>数据库<strong>表</strong>映射为编程语言中的类（Class）</li>
<li>表中的<strong>行</strong>映射为类的实例（Object）</li>
<li><strong>字段</strong>则映射为对象属性</li>
</ul>
<p>例如，<code>User</code> 类对应数据库的 <code>users</code> 表，其属性 <code>name</code> 对应表中的 <code>name</code> 字段。</p>
<p>在 Python 的 ORM（对象关系映射）生态中，​<strong>SQLAlchemy</strong> 和 ​<strong>Tortoise ORM</strong> 是两大主流框架，但二者的设计理念和适用场景差异显著。以下是综合对比分析：</p>
<table>
<thead>
<tr>
<th>​<strong>特性</strong></th>
<th>​<strong>SQLAlchemy</strong></th>
<th>​<strong>Tortoise ORM</strong></th>
</tr>
</thead>
<tbody><tr>
<td>​<strong>异步支持</strong></td>
<td>同步为主，异步需依赖 <code>asyncio</code> 扩展</td>
<td>原生异步设计，基于 <code>asyncio</code></td>
</tr>
<tr>
<td>​<strong>模型定义语法</strong></td>
<td>手动声明式语法，灵活性高</td>
<td>类 Django ORM，简洁直观</td>
</tr>
<tr>
<td>​<strong>查询语法</strong></td>
<td>支持链式调用、复杂表达式和原生 SQL</td>
<td>类似 Django ORM 的过滤器语法</td>
</tr>
<tr>
<td>​<strong>适用场景</strong></td>
<td>复杂业务逻辑、精细控制 SQL 的场景</td>
<td>高并发异步应用（如 FastAPI）</td>
</tr>
<tr>
<td>​<strong>性能优化</strong></td>
<td>延迟加载、缓存机制成熟</td>
<td>异步 IO 提升吞吐量（实测 QPS 提升 10 倍）</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="4-6-2-Pydantic-与-Tortoise-ORM-模型集成"><a href="#4-6-2-Pydantic-与-Tortoise-ORM-模型集成" class="headerlink" title="4.6.2 Pydantic 与 Tortoise ORM 模型集成"></a>4.6.2 Pydantic 与 Tortoise ORM 模型集成</h4><p>以下是 ​<strong>Pydantic 与 Tortoise ORM 模型集成</strong>的经典案例实现，通过一个「用户注册与信息查询」场景，展示两者如何协作完成数据验证、ORM 操作和 API 响应：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tortoise <span class="keyword">import</span> fields, models</span><br><span class="line"><span class="keyword">from</span> tortoise.contrib.pydantic <span class="keyword">import</span> pydantic_model_creator</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, EmailStr</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, HTTPException</span><br><span class="line"></span><br><span class="line"><span class="comment"># ========== Tortoise ORM 模型定义 ==========</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(models.Model):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;用户表模型&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">id</span> = fields.IntField(pk=<span class="literal">True</span>)  <span class="comment"># 主键</span></span><br><span class="line">    username = fields.CharField(max_length=<span class="number">50</span>, unique=<span class="literal">True</span>)  <span class="comment"># 唯一用户名</span></span><br><span class="line">    email = fields.CharField(max_length=<span class="number">100</span>, unique=<span class="literal">True</span>)  <span class="comment"># 唯一邮箱</span></span><br><span class="line">    hashed_password = fields.CharField(max_length=<span class="number">128</span>)  <span class="comment"># 加密后的密码</span></span><br><span class="line">    created_at = fields.DatetimeField(auto_now_add=<span class="literal">True</span>)  <span class="comment"># 自动记录创建时间</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        table = <span class="string">&quot;users&quot;</span>  <span class="comment"># 显式指定表名</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;<span class="subst">&#123;self.username&#125;</span> (<span class="subst">&#123;self.email&#125;</span>)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ========== 自动生成 Pydantic 模型 ==========</span></span><br><span class="line"><span class="comment"># 创建用户时使用的模型（排除 id 和 created_at）</span></span><br><span class="line">UserCreate = pydantic_model_creator(</span><br><span class="line">    User, </span><br><span class="line">    name=<span class="string">&quot;UserCreate&quot;</span>,</span><br><span class="line">    exclude=(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;created_at&quot;</span>, <span class="string">&quot;hashed_password&quot;</span>)  <span class="comment"># 排除不需要的字段</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户信息响应模型（包含所有字段）</span></span><br><span class="line">UserOut = pydantic_model_creator(</span><br><span class="line">    User,</span><br><span class="line">    name=<span class="string">&quot;UserOut&quot;</span>,</span><br><span class="line">    exclude_readonly=<span class="literal">True</span>  <span class="comment"># 自动排除只读字段（如 auto_now_add）</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ========== FastAPI 路由与业务逻辑 ==========</span></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/users/&quot;</span>, response_model=UserOut</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_user</span>(<span class="params">user_data: UserCreate</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;用户注册接口&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 1. 检查用户名是否已存在（ORM查询）</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">await</span> User.exists(username=user_data.username):</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(<span class="number">400</span>, <span class="string">&quot;用户名已存在&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 2. 密码加密（模拟操作）</span></span><br><span class="line">    hashed_password = <span class="string">f&quot;encrypted_<span class="subst">&#123;user_data.password&#125;</span>&quot;</span>  <span class="comment"># 实际应使用 bcrypt 等库</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 3. 创建用户（ORM操作）</span></span><br><span class="line">    user = <span class="keyword">await</span> User.create(</span><br><span class="line">        username=user_data.username,</span><br><span class="line">        email=user_data.email,</span><br><span class="line">        hashed_password=hashed_password</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 4. 返回响应（自动转换为 UserOut 模型）</span></span><br><span class="line">    <span class="keyword">return</span> user</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/&#123;user_id&#125;&quot;</span>, response_model=UserOut</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">user_id: <span class="built_in">int</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;查询用户信息&quot;&quot;&quot;</span></span><br><span class="line">    user = <span class="keyword">await</span> User.get_or_none(<span class="built_in">id</span>=user_id)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(<span class="number">404</span>, <span class="string">&quot;用户不存在&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> user</span><br><span class="line"></span><br><span class="line"><span class="comment"># ========== 数据库初始化 ==========</span></span><br><span class="line"><span class="keyword">from</span> tortoise.contrib.fastapi <span class="keyword">import</span> register_tortoise</span><br><span class="line"></span><br><span class="line">register_tortoise(</span><br><span class="line">    app,</span><br><span class="line">    db_url=<span class="string">&quot;sqlite://db.sqlite3&quot;</span>,  <span class="comment"># 使用 SQLite</span></span><br><span class="line">    modules=&#123;<span class="string">&quot;models&quot;</span>: [<span class="string">&quot;__main__&quot;</span>]&#125;,  <span class="comment"># 注册当前模块的模型</span></span><br><span class="line">    generate_schemas=<span class="literal">True</span>,  <span class="comment"># 自动生成表结构</span></span><br><span class="line">    add_exception_handlers=<span class="literal">True</span>  <span class="comment"># 自动处理数据库异常</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ol>
<li>​**模型定义与自动生成<ul>
<li>​<strong>Tortoise ORM 模型</strong>：定义数据库表结构（如 <code>User</code> 类），通过字段类型（<code>CharField</code>、<code>DatetimeField</code>）映射数据库列。</li>
<li>​<strong>Pydantic 模型生成</strong>：<br>  使用 <code>pydantic_model_creator</code> <strong>自动生成</strong>：<ul>
<li><code>UserCreate</code>：用于接收注册请求数据（排除敏感字段 <code>hashed_password</code> 和自动生成的 <code>id</code>）。</li>
<li><code>UserOut</code>：用于序列化响应数据（自动过滤只读字段如 <code>created_at</code>）。</li>
</ul>
</li>
</ul>
</li>
<li>​<strong>数据验证流程</strong><ul>
<li>​<strong>请求验证</strong>：当调用 <code>/users/</code> 接口时，<code>user_data: UserCreate</code> 会自动校验请求体格式（如 <code>username</code> 是否超过 50 字符）。</li>
<li>​<strong>错误拦截</strong>：若校验失败，FastAPI 自动返回 HTTP 422 错误，无需手动处理</li>
</ul>
</li>
<li>​<strong>ORM 操作与响应转换</strong><ul>
<li>​<strong>数据库写入</strong>：<code>User.create(...)</code> 将验证后的数据写入数据库，<code>Tortoise</code> 自动处理 SQL 生成和执行。</li>
<li>​<strong>响应序列化</strong>：返回 <code>user</code> 对象时，FastAPI 通过 <code>response_model=UserOut</code> 自动调用 <code>UserOut.from_orm(user)</code>，将 ORM 对象转换为 JSON</li>
</ul>
</li>
</ol>
<p>通过这种方式，可以将数据库中的数据（通过 ORM 模型）转换为 <code>Pydantic</code> 模型，从而利用 <code>Pydantic</code> 提供的数据校验和序列化功能。</p>
<h4 id="4-6-3-手动生成Pydantic模型"><a href="#4-6-3-手动生成Pydantic模型" class="headerlink" title="4.6.3 手动生成Pydantic模型"></a>4.6.3 手动生成<code>Pydantic</code>模型</h4><p>除了通过<code>pydantic_model_creator</code>自动生成 <code>Pydantic</code> 模型，也可以手动生成<code>Pydantic</code> 模型</p>
<p>并且在 Pydantic 与 ORM（如 Tortoise）的协作中，​<strong>手动定义 Pydantic 模型</strong>是处理复杂业务场景的常用方案</p>
<h5 id="字段显式映射（ORM-→-Pydantic）"><a href="#字段显式映射（ORM-→-Pydantic）" class="headerlink" title="字段显式映射（ORM → Pydantic）"></a>字段显式映射（ORM → Pydantic）</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, EmailStr, Field</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="comment"># ========== 手动定义 Pydantic 模型 ==========</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserCreate</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;用户创建请求模型（手动版）&quot;&quot;&quot;</span></span><br><span class="line">    username: <span class="built_in">str</span> = Field(..., max_length=<span class="number">50</span>, example=<span class="string">&quot;john_doe&quot;</span>)</span><br><span class="line">    email: EmailStr = Field(..., example=<span class="string">&quot;john@example.com&quot;</span>)</span><br><span class="line">    password: <span class="built_in">str</span> = Field(..., min_length=<span class="number">8</span>, example=<span class="string">&quot;secure_password&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Config</span>:</span><br><span class="line">        <span class="comment"># 允许从 ORM 对象加载（需显式排除无关字段）</span></span><br><span class="line">        orm_mode = <span class="literal">True</span></span><br><span class="line">        <span class="comment"># 排除 ORM 模型中不存在的字段（如密码哈希）</span></span><br><span class="line">        exclude = &#123;<span class="string">&quot;id&quot;</span>, <span class="string">&quot;created_at&quot;</span>, <span class="string">&quot;hashed_password&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserOut</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;用户信息响应模型（手动版）&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">id</span>: <span class="built_in">int</span></span><br><span class="line">    username: <span class="built_in">str</span></span><br><span class="line">    email: EmailStr</span><br><span class="line">    created_at: datetime  <span class="comment"># 直接映射 ORM 的 created_at 字段</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Config</span>:</span><br><span class="line">        orm_mode = <span class="literal">True</span>  <span class="comment"># 允许从 ORM 对象转换</span></span><br><span class="line">        json_encoders = &#123;</span><br><span class="line">            datetime: <span class="keyword">lambda</span> dt: dt.strftime(<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>)  <span class="comment"># 自定义时间格式</span></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h5 id="自定义验证逻辑"><a href="#自定义验证逻辑" class="headerlink" title="自定义验证逻辑"></a>自定义验证逻辑</h5><p>手动模型支持添加字段级或模型级校验：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> field_validator</span><br><span class="line"><span class="keyword">from</span> tortoise <span class="keyword">import</span> fields  </span><br><span class="line"><span class="keyword">from</span> tortoise.models <span class="keyword">import</span> Model  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TimestampMixin</span>(<span class="title class_ inherited__">Model</span>):  </span><br><span class="line">    <span class="string">&quot;&quot;&quot;时间戳抽象模型&quot;&quot;&quot;</span>  </span><br><span class="line">    create_time = fields.DatetimeField(auto_now_add=<span class="literal">True</span>, description=<span class="string">&#x27;创建时间&#x27;</span>)  </span><br><span class="line">    update_time = fields.DatetimeField(auto_now=<span class="literal">True</span>, description=<span class="string">&quot;更新时间&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:  </span><br><span class="line">        abstract = <span class="literal">True</span>  <span class="comment"># 抽象模型 数据库中不生成表</span></span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TimestampSchema</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    create_time: datetime</span><br><span class="line">    update_time: datetime</span><br><span class="line"></span><br><span class="line"><span class="meta">    @field_validator(<span class="params"><span class="string">&quot;create_time&quot;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">validate_create_time</span>(<span class="params">cls, v</span>):</span><br><span class="line">        <span class="keyword">if</span> v &gt; datetime.now():</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;创建时间不能晚于当前时间&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> v</span><br></pre></td></tr></table></figure>

<h1 id="请求参数和验证"><a href="#请求参数和验证" class="headerlink" title="请求参数和验证"></a>请求参数和验证</h1><ul>
<li>​<strong>路由管理</strong>：使用 <code>APIRouter</code> 组织代码。</li>
<li>​<strong>参数类型</strong>：路径参数、查询参数、请求体、Cookie、Header。</li>
<li>​<strong>数据验证</strong>：利用 <code>Query</code>、<code>Path</code>、<code>Field</code> 和 <code>BaseModel</code> 实现严格校验。</li>
<li>​<strong>文档生成</strong>：通过代码注释和模型定义自动生成API文档。</li>
</ul>
<h2 id="1-路由管理"><a href="#1-路由管理" class="headerlink" title="1 路由管理"></a>1 路由管理</h2><ul>
<li>​<strong>作用</strong>：将不同功能的路由分组管理</li>
</ul>
<p><img src="https://picgocloud.oss-cn-shanghai.aliyuncs.com/picgo/20250314220656.png" alt="image.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app03 = APIRouter()  <span class="comment"># 创建路由实例</span></span><br><span class="line"><span class="meta">@app03.get(<span class="params"><span class="string">&quot;/path/parameters&quot;</span></span>)  </span><span class="comment"># 定义GET路由</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">path_params01</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;This is a message&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>使用 <code>APIRouter()</code> 创建模块化的路由。</li>
<li>通过装饰器（如 <code>@app03.get</code>）绑定HTTP方法与路径。</li>
</ul>
<h2 id="2-参数类型"><a href="#2-参数类型" class="headerlink" title="2 参数类型"></a>2 参数类型</h2><h3 id="2-1-路径参数（Path-Parameters）"><a href="#2-1-路径参数（Path-Parameters）" class="headerlink" title="2.1 路径参数（Path Parameters）"></a>2.1 路径参数（Path Parameters）</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app03.get(<span class="params"><span class="string">&quot;/path/&#123;parameters&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">path_params02</span>(<span class="params">parameters: <span class="built_in">str</span></span>): </span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: parameters&#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义一个枚举类，表示城市名称  </span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CityName</span>(<span class="built_in">str</span>, Enum):  </span><br><span class="line">    Beijing = <span class="string">&quot;Beijing China&quot;</span>  </span><br><span class="line">    Shanghai = <span class="string">&quot;Shanghai China&quot;</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">@app03.get(<span class="params"><span class="string">&quot;/enum/&#123;city&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">latest</span>(<span class="params">city: CityName</span>):  <span class="comment"># 枚举类型限定可选值</span></span><br><span class="line">    <span class="keyword">if</span> city == CityName.Shanghai:</span><br></pre></td></tr></table></figure>

<ul>
<li><code>&#123;parameters&#125;</code>为路径占位符，通过函数参数获取</li>
<li>支持类型约束（如<code>int</code>）和验证（<code>Path(..., ge=1, le=10)</code>）</li>
<li>枚举类型限制取值范围（<code>CityName</code>枚举类）</li>
</ul>
<h3 id="2-2-查询参数"><a href="#2-2-查询参数" class="headerlink" title="2.2 查询参数"></a>2.2 查询参数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app03.get(<span class="params"><span class="string">&quot;/query&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">page_limit</span>(<span class="params">page: <span class="built_in">int</span> = <span class="number">1</span>, limit: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="literal">None</span></span>):  <span class="comment"># 默认值使参数可选</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;page&quot;</span>: page&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@app03.get(<span class="params"><span class="string">&quot;/query/validations&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">query_params_validate</span>(<span class="params"></span></span><br><span class="line"><span class="params">    value: <span class="built_in">str</span> = Query(<span class="params">..., min_length=<span class="number">8</span>, regex=<span class="string">&quot;^a&quot;</span></span>),  <span class="comment"># 必填参数，正则验证</span></span></span><br><span class="line"><span class="params">    values: <span class="type">List</span>[<span class="built_in">str</span>] = Query(<span class="params">[<span class="string">&quot;v1&quot;</span>, <span class="string">&quot;v2&quot;</span>]</span>)  <span class="comment"># 多值列表参数</span></span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    <span class="keyword">return</span> value, values</span><br></pre></td></tr></table></figure>

<ul>
<li>通过<code>?key=value</code>形式传递（<code>http://host/query?page=2&amp;limit=10</code>）</li>
<li>必填 / 选填控制：<code>=None</code>表示选填，无默认值为必填</li>
<li>验证规则：<code>Query(..., min_length=8, regex=&quot;^a&quot;)</code> </li>
</ul>
<h3 id="2-3-请求体（Request-Body）​"><a href="#2-3-请求体（Request-Body）​" class="headerlink" title="2.3 请求体（Request Body）​"></a>2.3 请求体（Request Body）​</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CityInfo</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span> = Field(..., example=<span class="string">&quot;Beijing&quot;</span>)  <span class="comment"># ... 表示 name 是必需的参数; example=&quot;Beijing&quot; 提供了一个示例值，用于文档生成，但不会影响实际的验证</span></span><br><span class="line">    country: <span class="built_in">str</span></span><br><span class="line">    country_code: <span class="built_in">str</span> = <span class="literal">None</span>  <span class="comment"># 给一个默认值</span></span><br><span class="line">    country_population: <span class="built_in">int</span> = Field(default=<span class="number">800</span>, title=<span class="string">&quot;人口数量&quot;</span>, description=<span class="string">&quot;国家的人口数量&quot;</span>, ge=<span class="number">800</span>)  <span class="comment"># ge=800 表示 country_population 必须大于或等于 800</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Config 类用于配置 CityInfo 模型的行为。</span></span><br><span class="line">    <span class="comment"># schema_extra 是一个字典，用于提供额外的示例数据，用于文档生成。</span></span><br><span class="line">    <span class="comment"># example 字段提供了一个具体的示例对象，用于展示 CityInfo 模型的结构和可能的值。</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Config</span>:</span><br><span class="line">        schema_extra = &#123;</span><br><span class="line">            <span class="string">&quot;example&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Shanghai&quot;</span>,</span><br><span class="line">                <span class="string">&quot;country&quot;</span>: <span class="string">&quot;China&quot;</span>,</span><br><span class="line">                <span class="string">&quot;country_code&quot;</span>: <span class="string">&quot;CN&quot;</span>,</span><br><span class="line">                <span class="string">&quot;country_population&quot;</span>: <span class="number">1400000000</span>,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@app03.post(<span class="params"><span class="string">&quot;/request_body/city&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">city_info</span>(<span class="params">city: CityInfo</span>): <span class="comment"># 因为CityInfo继承了BaseModel，所以可以自动验证，并且可以自动生成文档</span></span><br><span class="line">    <span class="comment"># 打印请求体中的城市信息</span></span><br><span class="line">    <span class="built_in">print</span>(city.name, city.country)  <span class="comment"># 当在IDE中输入city.的时候，属性会自动弹出</span></span><br><span class="line">    <span class="keyword">return</span> city.<span class="built_in">dict</span>()</span><br></pre></td></tr></table></figure>

<ul>
<li>用于 POST/PUT 等需要传输复杂数据的请求</li>
<li>通过 Pydantic 模型定义数据结构（自动生成文档）</li>
<li>字段验证：<code>Field(ge=800, title=&quot;人口数量&quot;)</code></li>
</ul>
<p><span style="color: #badc58; font-weight: 550;">嵌套模型：数据格式嵌套的请求体</span></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Data</span>(<span class="title class_ inherited__">BaseModel</span>):  </span><br><span class="line">    city: <span class="type">List</span>[CityInfo] = <span class="literal">None</span>  <span class="comment"># 这里就是定义数据格式嵌套的请求体  </span></span><br><span class="line">    date: date  <span class="comment"># 额外的数据类型，还有uuid datetime bytes frozenset等，参考：https://fastapi.tiangolo.com/tutorial/extra-data-types/  </span></span><br><span class="line">    confirmed: <span class="built_in">int</span> = Field(ge=<span class="number">0</span>, description=<span class="string">&quot;确诊数&quot;</span>, default=<span class="number">0</span>)  </span><br><span class="line">    deaths: <span class="built_in">int</span> = Field(ge=<span class="number">0</span>, description=<span class="string">&quot;死亡数&quot;</span>, default=<span class="number">0</span>)  </span><br><span class="line">    recovered: <span class="built_in">int</span> = Field(ge=<span class="number">0</span>, description=<span class="string">&quot;痊愈数&quot;</span>, default=<span class="number">0</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@app03.put(<span class="params"><span class="string">&quot;/request_body/nested&quot;</span></span>)  </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">nested_models</span>(<span class="params">data: Data</span>):  </span><br><span class="line">    <span class="comment"># 返回嵌套的数据模型  </span></span><br><span class="line">    <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure>

<h3 id="2-4-混合参数"><a href="#2-4-混合参数" class="headerlink" title="2.4 混合参数"></a>2.4 混合参数</h3><p>​路径参数 + 查询参数 + 请求体</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app03.put(<span class="params"><span class="string">&quot;/request_body/city/&#123;name&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mix_city_info</span>(<span class="params"></span></span><br><span class="line"><span class="params">    name: <span class="built_in">str</span>,  <span class="comment"># 路径参数</span></span></span><br><span class="line"><span class="params">    city01: CityInfo,  <span class="comment"># 请求体</span></span></span><br><span class="line"><span class="params">    confirmed: <span class="built_in">int</span> = Query(<span class="params">ge=<span class="number">0</span></span>)  <span class="comment"># 查询参数</span></span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<h3 id="2-5-Cookie-和-Header-参数"><a href="#2-5-Cookie-和-Header-参数" class="headerlink" title="2.5 Cookie 和 Header 参数"></a>2.5 Cookie 和 Header 参数</h3><h4 id="2-5-1-处理-Cookie-参数"><a href="#2-5-1-处理-Cookie-参数" class="headerlink" title="2.5.1 处理 Cookie 参数"></a>2.5.1 处理 Cookie 参数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app03.get(<span class="params"><span class="string">&quot;/cookie&quot;</span></span>)  </span><span class="comment"># 效果只能用Postman测试</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cookie</span>(<span class="params">cookie_id: <span class="type">Optional</span>[<span class="built_in">str</span>] = Cookie(<span class="params"><span class="literal">None</span></span>)</span>):  <span class="comment"># 定义Cookie参数需要使用Cookie类，否则就是查询参数</span></span><br><span class="line">    <span class="comment"># 返回Cookie参数</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;cookie_id&quot;</span>: cookie_id&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>cookie_id: Optional[str] = Cookie(None)</code>: 定义了一个名为 <code>cookie_id</code> 的 <code>Cookie</code> 参数。<ul>
<li><code>Optional[str]</code>: 表示 cookie_id 是一个可选的字符串类型。</li>
<li><code>Cookie(None)</code>: 使用 Cookie 类来定义 <code>cookie_id</code> 为一个 <code>Cookie</code> 参数，默认值为 <code>None</code>。</li>
</ul>
</li>
</ul>
<p><span style="color: #badc58; font-weight: 550;">示例</span></p>
<p>假设客户端发送一个 GET 请求，并且在请求头中包含以下 Cookie：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cookie: cookie_id=<span class="number">12345</span></span><br></pre></td></tr></table></figure>

<p>请求</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8000</span>/cookie</span><br></pre></td></tr></table></figure>

<p>响应</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;cookie_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;12345&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-5-2-处理-Header-参数"><a href="#2-5-2-处理-Header-参数" class="headerlink" title="2.5.2 处理 Header 参数"></a>2.5.2 处理 Header 参数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app03.get(<span class="params"><span class="string">&quot;/header&quot;</span></span>)  </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">header</span>(<span class="params">user_agent: <span class="type">Optional</span>[<span class="built_in">str</span>] = Header(<span class="params"><span class="literal">None</span>, convert_underscores=<span class="literal">True</span></span>), x_token: <span class="type">List</span>[<span class="built_in">str</span>] = Header(<span class="params"><span class="literal">None</span></span>)</span>):  </span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;User-Agent&quot;</span>: user_agent, <span class="string">&quot;x_token&quot;</span>: x_token&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>user_agent: Optional[str] = Header(None, convert_underscores=True)</code>:<ul>
<li><code>Optional[str]</code>: 表示 user_agent 是一个可选的字符串类型。</li>
<li><code>Header(None, convert_underscores=True)</code>: 使用 Header 类来定义 user_agent 为一个请求头参数，默认值为 None。</li>
<li><code>convert_underscores=True</code>: 允许将 user_agent 转换为 User-Agent，因为有些 HTTP 代理和服务器不允许请求头中带有下划线。</li>
</ul>
</li>
<li><code>x_token: List[str] = Header(None)</code>:<ul>
<li><code>List[str]</code>: 表示 x_token 是一个字符串列表类型。</li>
<li><code>Header(None)</code>: 使用 Header 类来定义 x_token 为一个请求头参数，默认值为 None。</li>
</ul>
</li>
</ul>
<p><span style="color: #badc58; font-weight: 550;">示例</span></p>
<p>假设客户端发送一个 GET 请求，并且在请求头中包含以下信息：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">User-Agent<span class="punctuation">:</span> Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">10.0</span>; Win64; x64) AppleWebKit/<span class="number">537.36</span> (KHTML<span class="punctuation">,</span> like Gecko) Chrome/<span class="number">91.0</span><span class="number">.4472</span><span class="number">.124</span> Safari/<span class="number">537.36</span></span><br><span class="line">x-token<span class="punctuation">:</span> token1</span><br><span class="line">x-token<span class="punctuation">:</span> token2</span><br></pre></td></tr></table></figure>

<p>请求</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8000</span>/header</span><br></pre></td></tr></table></figure>

<p>响应</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;User-Agent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;x_token&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;token1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;token2&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>如果客户端没有提供 User-Agent 或 x-token 请求头，则相应的值将为 None 或空列表。</p>
<h2 id="3-验证规则"><a href="#3-验证规则" class="headerlink" title="3 验证规则"></a>3 验证规则</h2><p>在 FastAPI 中，数据验证是核心功能之一，主要依赖 <code>Query</code>、<code>Path</code>、<code>Field</code> 和 Pydantic 的 <code>BaseModel</code>。以下是它们的验证规则总结：</p>
<h3 id="3-1-​1-Query（查询参数验证）​"><a href="#3-1-​1-Query（查询参数验证）​" class="headerlink" title="3.1 ​1. Query（查询参数验证）​"></a>3.1 ​1. <code>Query</code>（查询参数验证）​</h3><p>用于验证 URL 中的查询参数（如 <code>/items?name=foo</code>）。</p>
<h4 id="3-1-1-​常用验证规则："><a href="#3-1-1-​常用验证规则：" class="headerlink" title="3.1.1 ​常用验证规则："></a>3.1.1 ​常用验证规则：</h4><table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>default</code></td>
<td>默认值（若参数可选）</td>
<td><code>name: str = Query(&quot;default&quot;)</code></td>
</tr>
<tr>
<td><code>min_length</code></td>
<td>字符串最小长度</td>
<td><code>name: str = Query(..., min_length=3)</code></td>
</tr>
<tr>
<td><code>max_length</code></td>
<td>字符串最大长度</td>
<td><code>name: str = Query(..., max_length=10)</code></td>
</tr>
<tr>
<td><code>regex</code></td>
<td>正则表达式匹配</td>
<td><code>name: str = Query(..., regex=&quot;^a.*z$&quot;)</code></td>
</tr>
<tr>
<td><code>ge</code> / <code>gt</code></td>
<td>数值参数的最小值（<code>&gt;=</code>）或严格最小值（<code>&gt;</code>）</td>
<td><code>age: int = Query(..., ge=18)</code></td>
</tr>
<tr>
<td><code>le</code> / <code>lt</code></td>
<td>数值参数的最大值（<code>&lt;=</code>）或严格最大值（<code>&lt;</code>）</td>
<td><code>price: float = Query(..., lt=100.0)</code></td>
</tr>
<tr>
<td><code>alias</code></td>
<td>参数别名（用于 URL 中的不同名称）</td>
<td><code>item_name: str = Query(..., alias=&quot;name&quot;)</code></td>
</tr>
<tr>
<td><code>deprecated</code></td>
<td>标记参数已弃用（在文档中显示）</td>
<td><code>name: str = Query(..., deprecated=True)</code></td>
</tr>
<tr>
<td><code>title</code> / <code>description</code></td>
<td>文档中的标题和描述</td>
<td><code>Query(..., title=&quot;Name&quot;, description=&quot;用户名称&quot;)</code></td>
</tr>
</tbody></table>
<h4 id="3-1-2-​示例："><a href="#3-1-2-​示例：" class="headerlink" title="3.1.2 ​示例："></a>3.1.2 ​示例：</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app03.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_items</span>(<span class="params"></span></span><br><span class="line"><span class="params">    name: <span class="built_in">str</span> = Query(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="params">        ...,  <span class="comment"># 必填参数（无默认值）</span></span></span></span><br><span class="line"><span class="params"><span class="params">        min_length=<span class="number">3</span>,</span></span></span><br><span class="line"><span class="params"><span class="params">        max_length=<span class="number">10</span>,</span></span></span><br><span class="line"><span class="params"><span class="params">        regex=<span class="string">&quot;^[A-Za-z]+$&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="params">        title=<span class="string">&quot;Item Name&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="params">        description=<span class="string">&quot;必须为字母，长度3-10&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="params">    </span>),</span></span><br><span class="line"><span class="params">    age: <span class="built_in">int</span> = Query(<span class="params"><span class="number">18</span>, ge=<span class="number">18</span>, le=<span class="number">100</span></span>)</span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;name&quot;</span>: name, <span class="string">&quot;age&quot;</span>: age&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="3-2-​2-Path（路径参数验证）"><a href="#3-2-​2-Path（路径参数验证）" class="headerlink" title="3.2 ​2. Path（路径参数验证）"></a>3.2 ​2. <code>Path</code>（路径参数验证）</h3><p>用于验证 URL 路径中的参数（如 <code>/items/&#123;item_id&#125;</code>）。</p>
<h4 id="3-2-1-​常用验证规则："><a href="#3-2-1-​常用验证规则：" class="headerlink" title="3.2.1 ​常用验证规则："></a>3.2.1 ​常用验证规则：</h4><p>与 <code>Query</code> 类似，但额外支持：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>...</code></td>
<td>标记参数为必填（无默认值）</td>
<td><code>item_id: int = Path(..., ge=1)</code></td>
</tr>
</tbody></table>
<h4 id="3-2-2-​示例："><a href="#3-2-2-​示例：" class="headerlink" title="3.2.2 ​示例："></a>3.2.2 ​示例：</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app03.get(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_item</span>(<span class="params"></span></span><br><span class="line"><span class="params">    item_id: <span class="built_in">int</span> = Path(<span class="params">..., title=<span class="string">&quot;ID&quot;</span>, ge=<span class="number">1</span>, le=<span class="number">1000</span></span>),</span></span><br><span class="line"><span class="params">    name: <span class="built_in">str</span> = Query(<span class="params">..., min_length=<span class="number">3</span></span>)</span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;item_id&quot;</span>: item_id, <span class="string">&quot;name&quot;</span>: name&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-3-Field（Pydantic-模型字段验证）"><a href="#3-3-3-Field（Pydantic-模型字段验证）" class="headerlink" title="3.3 3. Field（Pydantic 模型字段验证）"></a>3.3 3. <code>Field</code>（Pydantic 模型字段验证）</h3><p>用于在 Pydantic 模型（继承 <code>BaseModel</code> 的类）中验证字段。</p>
<h4 id="3-3-1-​常用验证规则："><a href="#3-3-1-​常用验证规则：" class="headerlink" title="3.3.1 ​常用验证规则："></a>3.3.1 ​常用验证规则：</h4><p>与 <code>Query</code> 和 <code>Path</code> 类似，但专用于模型字段：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>default</code></td>
<td>默认值</td>
<td><code>name: str = Field(&quot;default&quot;)</code></td>
</tr>
<tr>
<td><code>min_length</code> / <code>max_length</code></td>
<td>字符串长度限制</td>
<td><code>name: str = Field(..., min_length=3)</code></td>
</tr>
<tr>
<td><code>regex</code></td>
<td>正则表达式匹配</td>
<td><code>email: str = Field(..., regex=&quot;^[a-zA-Z0-9+_.-]+@[a-zA-Z0-9.-]+$&quot;)</code></td>
</tr>
<tr>
<td><code>ge</code> / <code>gt</code> / <code>le</code> / <code>lt</code></td>
<td>数值范围限制</td>
<td><code>age: int = Field(..., ge=18)</code></td>
</tr>
<tr>
<td><code>title</code> / <code>description</code></td>
<td>文档中的标题和描述</td>
<td><code>Field(..., title=&quot;Age&quot;, description=&quot;用户年龄&quot;)</code></td>
</tr>
<tr>
<td><code>example</code></td>
<td>在文档中提供示例值</td>
<td><code>name: str = Field(..., example=&quot;Alice&quot;)</code></td>
</tr>
</tbody></table>
<h4 id="3-3-2-​示例："><a href="#3-3-2-​示例：" class="headerlink" title="3.3.2 ​示例："></a>3.3.2 ​示例：</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, Field</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span> = Field(..., min_length=<span class="number">3</span>, example=<span class="string">&quot;Alice&quot;</span>)</span><br><span class="line">    age: <span class="built_in">int</span> = Field(<span class="number">18</span>, ge=<span class="number">18</span>, le=<span class="number">100</span>, title=<span class="string">&quot;Age&quot;</span>)</span><br><span class="line">    email: <span class="built_in">str</span> = Field(..., regex=<span class="string">&quot;^[a-zA-Z0-9+_.-]+@[a-zA-Z0-9.-]+$&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app03.post(<span class="params"><span class="string">&quot;/users/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_user</span>(<span class="params">user: User</span>):</span><br><span class="line">    <span class="keyword">return</span> user</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="3-4-​4-BaseModel（结构化数据验证）"><a href="#3-4-​4-BaseModel（结构化数据验证）" class="headerlink" title="3.4 ​4. BaseModel（结构化数据验证）"></a>3.4 ​4. <code>BaseModel</code>（结构化数据验证）</h3><p>通过继承 <code>BaseModel</code> 定义数据模型，自动验证请求体、查询参数等结构化数据。</p>
<h4 id="3-4-1-​验证规则-："><a href="#3-4-1-​验证规则-：" class="headerlink" title="3.4.1 ​验证规则*："></a>3.4.1 ​验证规则*：</h4><ul>
<li>​<strong>类型提示</strong>：直接使用 <code>Python</code> 类型提示（如 <code>str</code>, <code>int</code>, <code>List</code>, <code>Optional</code>）。</li>
<li>​<strong>嵌套模型</strong>：支持多层嵌套的模型验证。</li>
<li>​<strong>自定义验证</strong>：可通过 <code>@validator</code> 装饰器添加自定义逻辑。</li>
</ul>
<h4 id="3-4-2-​示例："><a href="#3-4-2-​示例：" class="headerlink" title="3.4.2 ​示例："></a>3.4.2 ​示例：</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, validator</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Item</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    quantity: <span class="built_in">int</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @validator(<span class="params"><span class="string">&quot;price&quot;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">price_must_be_positive</span>(<span class="params">cls, v</span>):</span><br><span class="line">        <span class="keyword">if</span> v &lt;= <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;价格必须大于0&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> v</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Order</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    items: <span class="type">List</span>[Item]  <span class="comment"># 嵌套模型</span></span><br><span class="line">    total: <span class="built_in">float</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app03.post(<span class="params"><span class="string">&quot;/orders/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_order</span>(<span class="params">order: Order</span>):</span><br><span class="line">    <span class="keyword">return</span> order</span><br></pre></td></tr></table></figure>

<h3 id="3-5-​总结对比"><a href="#3-5-​总结对比" class="headerlink" title="3.5 ​总结对比"></a>3.5 ​总结对比</h3><table>
<thead>
<tr>
<th>验证工具</th>
<th>适用场景</th>
<th>特有功能</th>
</tr>
</thead>
<tbody><tr>
<td><code>Query</code></td>
<td>URL 查询参数</td>
<td><code>alias</code>, <code>deprecated</code></td>
</tr>
<tr>
<td><code>Path</code></td>
<td>URL 路径参数</td>
<td>强制必填（无默认值）</td>
</tr>
<tr>
<td><code>Field</code></td>
<td>Pydantic 模型字段</td>
<td><code>example</code>, 模型内部字段验证</td>
</tr>
<tr>
<td><code>BaseModel</code></td>
<td>结构化数据（请求体、嵌套数据）</td>
<td>类型提示、嵌套模型、自定义校验逻辑</td>
</tr>
</tbody></table>
<h1 id="响应处理"><a href="#响应处理" class="headerlink" title="响应处理"></a>响应处理</h1><h2 id="1-响应模型（Response-Model）"><a href="#1-响应模型（Response-Model）" class="headerlink" title="1 响应模型（Response Model）"></a>1 响应模型（Response Model）</h2><ul>
<li>​<strong>作用</strong>：控制 API 响应数据的结构和字段。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">UserIn</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    username: <span class="built_in">str</span></span><br><span class="line">    password: <span class="built_in">str</span>  <span class="comment"># 敏感字段，不希望在响应中返回</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserOut</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    username: <span class="built_in">str</span></span><br><span class="line">    email: EmailStr  <span class="comment"># 响应模型排除 password 字段</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app04.post(<span class="params"><span class="string">&quot;/response_model/&quot;</span>, response_model=UserOut, response_model_exclude_unset=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">response_model</span>(<span class="params">user: UserIn</span>):</span><br><span class="line">    <span class="keyword">return</span> users[<span class="string">&quot;user01&quot;</span>]</span><br></pre></td></tr></table></figure>

<ul>
<li><code>response_model</code>：指定响应数据模型（自动过滤未定义的字段）。</li>
<li><code>response_model_exclude_unset=True</code>：仅返回实际赋值的字段（忽略默认值）。</li>
<li><code>response_model_include = []</code> / <code>response_model_exclude = []</code>：显式包含或排除字段。</li>
</ul>
<p><span style="color: #badc58; font-weight: 550;">注意：</span></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">response_model=<span class="type">Union</span>[UserIn, UserOut] <span class="comment"># 二者取并集</span></span><br><span class="line"><span class="keyword">del</span> user.password  <span class="comment"># 删除password属性</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>Union[UserIn, UserOut]</code>后，删除<code>password</code>属性也能返回成功</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">response_model=<span class="type">List</span>[UserOut] <span class="comment"># 需要返回list</span></span><br><span class="line"><span class="keyword">return</span> [user, user]</span><br></pre></td></tr></table></figure>

<h2 id="2-响应状态码（Response-Status-Code）"><a href="#2-响应状态码（Response-Status-Code）" class="headerlink" title="2 响应状态码（Response Status Code）"></a>2 响应状态码（Response Status Code）</h2><p><strong>作用</strong>：定义 HTTP 响应的状态码。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app04.post(<span class="params"><span class="string">&quot;/status_code&quot;</span>, status_code=<span class="number">200</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">status_code</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;status_code&quot;</span>: <span class="number">200</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@app04.post(<span class="params"><span class="string">&quot;/status_attribute&quot;</span>, status_code=status.HTTP_200_OK</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">status_attribute</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;status_code&quot;</span>: status.HTTP_200_OK&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>直接使用数值（如 <code>200</code>）或 <code>status</code> 模块的常量（如 <code>status.HTTP_200_OK</code>）。</li>
<li>推荐使用 <code>status</code> 模块，提高代码可读性。</li>
</ul>
<h2 id="3-表单数据处理（Form-Data）​"><a href="#3-表单数据处理（Form-Data）​" class="headerlink" title="3 表单数据处理（Form Data）​"></a>3 表单数据处理（Form Data）​</h2><ul>
<li><strong>作用</strong>：处理 HTML 表单提交的数据（如登录）。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app04.post(<span class="params"><span class="string">&quot;/login/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">login</span>(<span class="params">username: <span class="built_in">str</span> = Form(<span class="params">...</span>), password: <span class="built_in">str</span> = Form(<span class="params">...</span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;username&quot;</span>: username&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>必须安装 <code>python-multipart</code> 库：<code>pip install python-multipart</code></li>
<li><code>Form</code> 的用法与 <code>Query</code>、<code>Path</code> 类似，支持参数验证。这里<code>Form(...)</code>代表必填字段</li>
</ul>
<p><img src="https://picgocloud.oss-cn-shanghai.aliyuncs.com/picgo/20250301104044.png" alt="image.png"></p>
<h2 id="4-文件上传（File-Upload）"><a href="#4-文件上传（File-Upload）" class="headerlink" title="4 文件上传（File Upload）"></a>4 文件上传（File Upload）</h2><ul>
<li>​<strong>作用</strong>：处理单文件或多文件上传。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 小文件（直接读入内存）</span></span><br><span class="line"><span class="meta">@app04.post(<span class="params"><span class="string">&quot;/file&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">file_</span>(<span class="params">file: <span class="built_in">bytes</span> = File(<span class="params">...</span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;file_size&quot;</span>: <span class="built_in">len</span>(file)&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 大文件（使用 UploadFile，支持异步）</span></span><br><span class="line"><span class="meta">@app04.post(<span class="params"><span class="string">&quot;/upload_files&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">upload_files</span>(<span class="params">files: <span class="type">List</span>[UploadFile] = File(<span class="params">...</span>)</span>):</span><br><span class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">        contents = <span class="keyword">await</span> file.read()</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;filename&quot;</span>: files[<span class="number">0</span>].filename&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>上传单个就<code>file: UploadFile</code>，上传多个文件就<code>files: List[UploadFile]</code></li>
<li>​<code>UploadFile</code> 的优势：<ul>
<li>支持大文件（内存达到阈值后写入磁盘）。</li>
<li>提供文件名、类型等元数据。</li>
<li>异步读写方法（如 <code>read()</code>, <code>write()</code>）。</li>
</ul>
</li>
</ul>
<p><img src="https://picgocloud.oss-cn-shanghai.aliyuncs.com/picgo/20250301104534.png" alt="image.png"></p>
<ul>
<li>具体实现文件上传需要结合 <code>minio</code>对象存储</li>
</ul>
<h2 id="5-路径操作配置（Path-Operation-Configuration）"><a href="#5-路径操作配置（Path-Operation-Configuration）" class="headerlink" title="5 路径操作配置（Path Operation Configuration）"></a>5 路径操作配置（Path Operation Configuration）</h2><p><strong>作用</strong>：增强 API 文档的可读性。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app04.post(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="meta">    <span class="string">&quot;/path_operation_configuration&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="meta">    response_model=UserOut,</span></span></span><br><span class="line"><span class="params"><span class="meta">    summary=<span class="string">&quot;This is summary&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="meta">    description=<span class="string">&quot;This is description&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="meta">    deprecated=<span class="literal">True</span></span></span></span><br><span class="line"><span class="params"><span class="meta"></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">path_operation_configuration</span>(<span class="params">user: UserIn</span>):</span><br><span class="line">    <span class="keyword">return</span> user.<span class="built_in">dict</span>()</span><br></pre></td></tr></table></figure>

<ul>
<li>​<strong>常用参数</strong>：<ul>
<li><code>tags</code>：分组 API 文档。</li>
<li><code>summary</code> / <code>description</code>：接口摘要和详细说明。</li>
<li><code>deprecated</code>：标记接口已弃用。</li>
</ul>
</li>
</ul>
<h1 id="FastAPI-基础配置"><a href="#FastAPI-基础配置" class="headerlink" title="FastAPI 基础配置"></a>FastAPI 基础配置</h1><h2 id="1-FastAPI-应用全局配置"><a href="#1-FastAPI-应用全局配置" class="headerlink" title="1 FastAPI 应用全局配置"></a>1 FastAPI 应用全局配置</h2><p>在初始化 <code>FastAPI</code> 应用时，可配置 API 文档路径、标题、描述等元信息：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">app = FastAPI(</span><br><span class="line">    title=<span class="string">&quot;FastAPI Tutorial and Coronavirus Tracker API Docs&quot;</span>,</span><br><span class="line">    description=<span class="string">&quot;FastAPI教程 新冠病毒疫情跟踪器API接口文档&quot;</span>,</span><br><span class="line">    version=<span class="string">&quot;1.0.0&quot;</span>,</span><br><span class="line">    docs_url=<span class="string">&quot;/docs&quot;</span>,       <span class="comment"># 指定 Swagger UI 文档路径（默认是 /docs）</span></span><br><span class="line">    redoc_url=<span class="string">&quot;/redocs&quot;</span>,    <span class="comment"># 指定 ReDoc 文档路径（默认是 /redoc）</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><img src="https://picgocloud.oss-cn-shanghai.aliyuncs.com/picgo/20250301105418.png" alt="image.png"></p>
<h2 id="2-挂载静态文件"><a href="#2-挂载静态文件" class="headerlink" title="2 挂载静态文件"></a>2 挂载静态文件</h2><p>使用 <code>app.mount</code> 将静态文件目录挂载到指定路径：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app.mount(</span><br><span class="line">    path=<span class="string">&quot;/static&quot;</span>,</span><br><span class="line">    app=StaticFiles(directory=<span class="string">&quot;./coronavirus/static&quot;</span>),</span><br><span class="line">    name=<span class="string">&quot;static&quot;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li>​<strong>作用</strong>：将 <code>./coronavirus/static</code> 目录下的静态文件（如 CSS、JS、图片）通过 <code>/static</code> 路径对外提供服务。</li>
<li>​<strong>注意事项</strong>：<ul>
<li><code>mount</code> 应直接在 <code>FastAPI</code> 主应用上调用，<strong>而非</strong>在 <code>APIRouter</code> 中使用，否则可能导致模板路径错误。</li>
<li>挂载的静态文件不会显示在 API 文档中。</li>
</ul>
</li>
</ul>
<h2 id="3-自定义异常处理器"><a href="#3-自定义异常处理器" class="headerlink" title="3 自定义异常处理器"></a>3 自定义异常处理器</h2><p>FastAPI 允许覆盖默认异常处理逻辑，返回自定义响应格式。</p>
<p>通过自定义异常处理器，您可以：</p>
<ul>
<li>统一错误响应的数据格式（如纯文本、JSON）。</li>
<li>控制错误信息的暴露程度。</li>
<li>适配客户端对错误处理的具体需求（如兼容旧版 API）</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 全局异常处理器配置  </span></span><br><span class="line">app.add_exception_handler(HTTPException, Exception.http_error_handler)  <span class="comment"># HTTP标准异常  </span></span><br><span class="line">app.add_exception_handler(RequestValidationError, Exception.http422_error_handler)  <span class="comment"># 请求参数校验异常  </span></span><br><span class="line">app.add_exception_handler(Exception.UnicornException, Exception.unicorn_exception_handler)  <span class="comment"># 自定义业务异常  </span></span><br><span class="line">app.add_exception_handler(DoesNotExist, Exception.mysql_does_not_exist)  <span class="comment"># 数据库查询无结果  </span></span><br><span class="line">app.add_exception_handler(IntegrityError, Exception.mysql_integrity_error)  <span class="comment"># 数据完整性约束异常  </span></span><br><span class="line">app.add_exception_handler(ValidationError, Exception.mysql_validation_error)  <span class="comment"># 数据验证失败  </span></span><br><span class="line">app.add_exception_handler(OperationalError, Exception.mysql_operational_error)  <span class="comment"># 数据库操作异常</span></span><br></pre></td></tr></table></figure>

<h3 id="3-1-处理-HTTP-异常"><a href="#3-1-处理-HTTP-异常" class="headerlink" title="3.1 处理 HTTP 异常"></a>3.1 处理 HTTP 异常</h3><p>覆盖 <code>StarletteHTTPException</code>（FastAPI 的 HTTP 异常基类）的处理器：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">http_error_handler</span>(<span class="params">_: Request, exc: HTTPException</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    处理HTTP异常。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    当发生HTTP异常时触发此异常处理器，根据异常的状态码返回相应的错误信息。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        _: 请求对象 (未使用)</span></span><br><span class="line"><span class="string">        exc: HTTP异常</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        JSONResponse: 包含错误代码、消息和数据的JSON响应</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> exc.status_code == <span class="number">401</span>:</span><br><span class="line">        <span class="keyword">return</span> JSONResponse(&#123;<span class="string">&quot;detail&quot;</span>: exc.detail&#125;, status_code=exc.status_code)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> JSONResponse(&#123;</span><br><span class="line">        <span class="string">&quot;code&quot;</span>: exc.status_code,</span><br><span class="line">        <span class="string">&quot;message&quot;</span>: exc.detail,</span><br><span class="line">        <span class="string">&quot;data&quot;</span>: exc.detail</span><br><span class="line">    &#125;, status_code=exc.status_code, headers=exc.headers)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>request</code>：必须保留，用于传递请求对象（即使未使用）。</li>
<li><code>exc</code>：捕获的异常对象，包含 <code>detail</code> 和 <code>status_code</code> 属性。</li>
</ul>
<h3 id="3-2-​处理请求验证错误"><a href="#3-2-​处理请求验证错误" class="headerlink" title="3.2 ​处理请求验证错误"></a>3.2 ​处理请求验证错误</h3><p>覆盖 <code>RequestValidationError</code>（请求数据验证失败时的异常）的处理器：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">http422_error_handler</span>(<span class="params">_: Request, exc: <span class="type">Union</span>[RequestValidationError, ValidationError], </span>) -&gt; JSONResponse:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    处理参数校验错误。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    当请求参数校验失败时触发此异常处理器，返回422状态码和详细的错误信息。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        _: 请求对象 (未使用)</span></span><br><span class="line"><span class="string">        exc: 参数校验异常</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        JSONResponse: 包含错误代码、消息和数据的JSON响应</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[422]&quot;</span>, exc.errors())</span><br><span class="line">    <span class="keyword">return</span> JSONResponse(</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;code&quot;</span>: status.HTTP_422_UNPROCESSABLE_ENTITY,</span><br><span class="line">            <span class="string">&quot;message&quot;</span>: <span class="string">f&quot;数据校验错误 <span class="subst">&#123;exc.errors()&#125;</span>&quot;</span>,</span><br><span class="line">            <span class="string">&quot;data&quot;</span>: exc.errors(),</span><br><span class="line">        &#125;,</span><br><span class="line">        status_code=<span class="number">422</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-3-​注意事项"><a href="#3-3-​注意事项" class="headerlink" title="3.3 ​注意事项"></a>3.3 ​注意事项</h3><ol>
<li>​<strong>异常处理器顺序</strong>：<ul>
<li>自定义处理器会覆盖 <code>FastAPI</code> 默认处理器。</li>
<li>多个处理器按定义顺序匹配第一个符合条件的异常类型。</li>
</ul>
</li>
<li>​<strong>依赖安装</strong>：<ul>
<li>使用 <code>PlainTextResponse</code> 无需额外安装库。</li>
<li>若需返回 HTML 或 JSON，可替换为 <code>HTMLResponse</code> 或 <code>JSONResponse</code>。</li>
</ul>
</li>
<li>​<strong>调试信息</strong>：<ul>
<li>生产环境中应避免返回详细错误堆栈，以防敏感信息泄露。</li>
</ul>
</li>
</ol>
<h2 id="4-生命周期事件"><a href="#4-生命周期事件" class="headerlink" title="4 生命周期事件"></a>4 生命周期事件</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">app.add_event_handler(<span class="string">&quot;startup&quot;</span>, Events.startup(app))  <span class="comment"># 服务启动时初始化数据库  </span></span><br><span class="line">app.add_event_handler(<span class="string">&quot;shutdown&quot;</span>, Events.stopping(app))  <span class="comment"># 服务停止时释放资源</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">startup</span>(<span class="params">app: FastAPI</span>) -&gt; <span class="type">Callable</span>:  </span><br><span class="line">    <span class="string">&quot;&quot;&quot;  </span></span><br><span class="line"><span class="string">    FastApi 启动完成事件  </span></span><br><span class="line"><span class="string">    :param app: FastAPI    :return: start_app  </span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>  </span><br><span class="line">    <span class="keyword">try</span>:  </span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">app_start</span>() -&gt; <span class="literal">None</span>:  </span><br><span class="line">            <span class="comment"># APP启动完成后触发  </span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;FastApi启动成功&quot;</span>)  </span><br><span class="line">            <span class="keyword">await</span> link_db(app)  <span class="comment"># 连接数据库  </span></span><br><span class="line">            <span class="keyword">await</span> link_redis(app)  <span class="comment"># 注入redis缓存到app.state  </span></span><br><span class="line">            <span class="keyword">pass</span>  </span><br><span class="line">        <span class="keyword">return</span> app_start  </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:  </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;FastApi启动失败&quot;</span>, e)  </span><br><span class="line">        <span class="keyword">raise</span> e</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">stopping</span>(<span class="params">app: FastAPI</span>) -&gt; <span class="type">Callable</span>:  </span><br><span class="line">    <span class="string">&quot;&quot;&quot;  </span></span><br><span class="line"><span class="string">    FastApi 停止事件  </span></span><br><span class="line"><span class="string">    :param app: FastAPI    :return: stop_app  </span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>  </span><br><span class="line">    <span class="keyword">try</span>:  </span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">stop_app</span>() -&gt; <span class="literal">None</span>:  </span><br><span class="line">            <span class="comment"># APP停止时触发  </span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;FastApi关闭成功&quot;</span>)  </span><br><span class="line">            <span class="keyword">await</span> close_db()  <span class="comment"># 关闭所有数据库连接  </span></span><br><span class="line">            <span class="keyword">await</span> close_redis(app)  <span class="comment"># 关闭redis  </span></span><br><span class="line">        <span class="keyword">return</span> stop_app  </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:  </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;FastApi关闭失败&quot;</span>, e)  </span><br><span class="line">        <span class="keyword">raise</span> e</span><br></pre></td></tr></table></figure>

<h2 id="5-环境变量"><a href="#5-环境变量" class="headerlink" title="5 环境变量"></a>5 环境变量</h2><p><img src="https://picgocloud.oss-cn-shanghai.aliyuncs.com/picgo/20250317101723.png" alt="image.png"></p>
<p><code>config</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-  </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;  </span></span><br><span class="line"><span class="string">@Created on : 2022/4/22 22:02  </span></span><br><span class="line"><span class="string">@Author: binkuolo  </span></span><br><span class="line"><span class="string">@Des: 基本配置文件  </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> os  </span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv, find_dotenv  </span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseSettings  </span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Config</span>(<span class="title class_ inherited__">BaseSettings</span>):  </span><br><span class="line">    <span class="comment"># 加载环境变量  </span></span><br><span class="line">    load_dotenv(find_dotenv(), override=<span class="literal">True</span>)  </span><br><span class="line">    <span class="comment"># 调试模式  </span></span><br><span class="line">    APP_DEBUG: <span class="built_in">bool</span> = <span class="literal">True</span>  </span><br><span class="line">    <span class="comment"># 项目信息  </span></span><br><span class="line">    VERSION: <span class="built_in">str</span> = <span class="string">&quot;0.0.1&quot;</span>  </span><br><span class="line">    PROJECT_NAME: <span class="built_in">str</span> = <span class="string">&quot;fastapi_learn&quot;</span>  </span><br><span class="line">    DESCRIPTION: <span class="built_in">str</span> = <span class="string">&#x27;&lt;a href=&quot;/redoc&quot; target=&quot;_blank&quot;&gt;redoc&lt;/a&gt;&#x27;</span>  </span><br><span class="line">    <span class="comment"># 静态资源目录  </span></span><br><span class="line">    STATIC_DIR: <span class="built_in">str</span> = os.path.join(os.getcwd(), <span class="string">&quot;static&quot;</span>)  </span><br><span class="line">    TEMPLATE_DIR: <span class="built_in">str</span> = os.path.join(STATIC_DIR, <span class="string">&quot;templates&quot;</span>)  </span><br><span class="line">    <span class="comment"># 跨域请求  </span></span><br><span class="line">    CORS_ORIGINS: <span class="type">List</span> = [<span class="string">&quot;http://localhost:5173&quot;</span>]  </span><br><span class="line">    CORS_ALLOW_CREDENTIALS: <span class="built_in">bool</span> = <span class="literal">True</span>  </span><br><span class="line">    CORS_ALLOW_METHODS: <span class="type">List</span> = [<span class="string">&quot;*&quot;</span>]  </span><br><span class="line">    CORS_ALLOW_HEADERS: <span class="type">List</span> = [<span class="string">&quot;*&quot;</span>]  </span><br><span class="line">    <span class="comment"># Session  </span></span><br><span class="line">    SECRET_KEY = <span class="string">&quot;session&quot;</span>  </span><br><span class="line">    SESSION_COOKIE = <span class="string">&quot;session_id&quot;</span>  </span><br><span class="line">    SESSION_MAX_AGE = <span class="number">14</span> * <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span>  </span><br><span class="line">    <span class="comment"># Jwt  </span></span><br><span class="line">    JWT_SECRET_KEY = <span class="string">&quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;</span>  </span><br><span class="line">    JWT_ALGORITHM = <span class="string">&quot;HS256&quot;</span>  </span><br><span class="line">    JWT_ACCESS_TOKEN_EXPIRE_MINUTES = <span class="number">24</span> * <span class="number">60</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="comment"># 环境变量文件 会覆盖上面的配置  </span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Config</span>:  </span><br><span class="line">        env_file = (<span class="string">&quot;.env&quot;</span>, <span class="string">&quot;.env.prod&quot;</span>) <span class="comment"># 后面的文件会覆盖前面的文件  </span></span><br><span class="line">        env_file_encoding = <span class="string">&quot;utf-8&quot;</span>  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">settings = Config()</span><br></pre></td></tr></table></figure>

<h1 id="FastApi-的-中间件"><a href="#FastApi-的-中间件" class="headerlink" title="FastApi 的 中间件"></a><code>FastApi</code> 的 中间件</h1><h2 id="1-中间件"><a href="#1-中间件" class="headerlink" title="1 中间件"></a>1 中间件</h2><p><img src="https://picgocloud.oss-cn-shanghai.aliyuncs.com/picgo/20250301172500.png" alt="image.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自定义中间件：记录每个请求的处理时间，并将处理时间添加到响应头中</span></span><br><span class="line"><span class="meta">@app.middleware(<span class="params"><span class="string">&#x27;http&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">add_process_time_header</span>(<span class="params">request: Request, call_next</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    记录每个HTTP请求的处理时间，并在响应头中添加该时间。</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    参数:</span></span><br><span class="line"><span class="string">    - request (Request): 当前的HTTP请求对象。</span></span><br><span class="line"><span class="string">    - call_next (Callable): 一个可调用对象，用于传递请求给下一个中间件或路由处理函数。</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    返回:</span></span><br><span class="line"><span class="string">    - response (Response): 处理后的HTTP响应对象，包含处理时间的自定义头信息。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 记录请求开始时间</span></span><br><span class="line">    start_time = time.time()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 调用下一个中间件或路由处理函数，并获取响应对象</span></span><br><span class="line">    response = <span class="keyword">await</span> call_next(request)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 计算请求处理时间</span></span><br><span class="line">    process_time = time.time() - start_time</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 将处理时间添加到响应头中，使用自定义头 &#x27;X-Process-Time&#x27;</span></span><br><span class="line">    response.headers[<span class="string">&#x27;X-Process-Time&#x27;</span>] = <span class="built_in">str</span>(process_time)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 返回最终的响应对象</span></span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>带 <code>yield</code> 的依赖的 <strong>退出部分的代码</strong> 和 <strong>后台任务</strong> 会在中间件之后运行</li>
</ul>
<h2 id="2-跨域"><a href="#2-跨域" class="headerlink" title="2 跨域"></a>2 跨域</h2><h3 id="2-1-什么是跨域？"><a href="#2-1-什么是跨域？" class="headerlink" title="2.1 什么是跨域？"></a>2.1 什么是跨域？</h3><p>当浏览器请求的 ​<strong>协议（HTTP/HTTPS）​</strong>、<strong>域名（ <a target="_blank" rel="noopener" href="http://www.example.com/">http://www.example.com</a> ）​</strong>​ 或 ​<strong>端口（8080）​</strong>​ 中任意一项与当前页面不同时，即视为<strong>跨域请求</strong>。</p>
<h4 id="2-1-1-​同源策略示例"><a href="#2-1-1-​同源策略示例" class="headerlink" title="2.1.1 ​同源策略示例"></a>2.1.1 ​同源策略示例</h4><table>
<thead>
<tr>
<th>当前页面 URL</th>
<th>请求目标 URL</th>
<th>是否跨域</th>
<th>原因</th>
</tr>
</thead>
<tbody><tr>
<td><code>https://www.example.com</code></td>
<td><code>https://www.example.com/api</code></td>
<td>否</td>
<td>完全一致</td>
</tr>
<tr>
<td><code>http://localhost:3000</code></td>
<td><code>http://localhost:8080/api</code></td>
<td>是</td>
<td>端口不同</td>
</tr>
<tr>
<td><code>https://api.example.com</code></td>
<td><code>https://example.com/api</code></td>
<td>是</td>
<td>子域名不同</td>
</tr>
<tr>
<td><code>http://example.com</code></td>
<td><code>https://example.com/api</code></td>
<td>是</td>
<td>协议不同（HTTP vs HTTPS）</td>
</tr>
</tbody></table>
<h3 id="2-2-为什么需要跨域限制？"><a href="#2-2-为什么需要跨域限制？" class="headerlink" title="2.2 为什么需要跨域限制？"></a>2.2 为什么需要跨域限制？</h3><p>浏览器通过<strong>同源策略（Same-Origin Policy）​</strong>​ 防止恶意攻击：</p>
<ol>
<li>​<strong>阻止跨站请求伪造（CSRF）​</strong></li>
<li>​<strong>防止敏感数据泄露</strong></li>
<li>​<strong>限制恶意脚本访问其他网站资源</strong></li>
</ol>
<h3 id="2-3-​如何解决跨域问题？"><a href="#2-3-​如何解决跨域问题？" class="headerlink" title="2.3 ​如何解决跨域问题？"></a>2.3 ​如何解决跨域问题？</h3><h4 id="2-3-1-​CORS（跨域资源共享）"><a href="#2-3-1-​CORS（跨域资源共享）" class="headerlink" title="2.3.1 ​CORS（跨域资源共享）"></a>2.3.1 ​CORS（跨域资源共享）</h4><p>现代浏览器的标准解决方案，需<strong>服务器设置响应头</strong>。</p>
<p><strong>FastAPI 配置示例</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 添加CORS中间件：允许跨域资源共享</span></span><br><span class="line">app.add_middleware(</span><br><span class="line">    CORSMiddleware,</span><br><span class="line">    allow_origins=[</span><br><span class="line">        <span class="string">&quot;http://127.0.0.1&quot;</span>,  <span class="comment"># 允许来自本地主机的请求</span></span><br><span class="line">        <span class="string">&quot;http://127.0.0.1:8080&quot;</span>  <span class="comment"># 允许来自本地主机8080端口的请求（例如前端开发服务器）</span></span><br><span class="line">    ],</span><br><span class="line">    allow_credentials=<span class="literal">True</span>,  <span class="comment"># 允许发送凭据（如Cookies）</span></span><br><span class="line">    allow_methods=[<span class="string">&quot;*&quot;</span>],  <span class="comment"># 允许所有HTTP方法（GET、POST、PUT、DELETE等）</span></span><br><span class="line">    allow_headers=[<span class="string">&quot;*&quot;</span>]  <span class="comment"># 允许所有HTTP头部</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h4 id="2-3-2-代理服务器"><a href="#2-3-2-代理服务器" class="headerlink" title="2.3.2 代理服务器"></a>2.3.2 代理服务器</h4><p>前端通过<strong>同域代理</strong>转发请求：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Nginx 配置示例</span></span><br><span class="line"><span class="section">location</span> /api/ &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://backend-server:8000/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-CORS-核心响应头"><a href="#2-4-CORS-核心响应头" class="headerlink" title="2.4 CORS 核心响应头"></a>2.4 CORS 核心响应头</h3><table>
<thead>
<tr>
<th>响应头</th>
<th>作用</th>
<th>示例值</th>
</tr>
</thead>
<tbody><tr>
<td><code>Access-Control-Allow-Origin</code></td>
<td>允许的域名</td>
<td><code>http://localhost:3000</code></td>
</tr>
<tr>
<td><code>Access-Control-Allow-Methods</code></td>
<td>允许的 HTTP 方法</td>
<td><code>GET, POST, PUT</code></td>
</tr>
<tr>
<td><code>Access-Control-Allow-Headers</code></td>
<td>允许的请求头</td>
<td><code>Content-Type, Authorization</code></td>
</tr>
<tr>
<td><code>Access-Control-Max-Age</code></td>
<td>预检请求缓存时间（秒）</td>
<td><code>86400</code>（24小时）</td>
</tr>
</tbody></table>
<h1 id="FastApi-的依赖注入系统"><a href="#FastApi-的依赖注入系统" class="headerlink" title="FastApi 的依赖注入系统"></a><code>FastApi</code> 的依赖注入系统</h1><p>依赖注入”是指在编程中，为保证代码成功运行，先导入或声明其所需要的 “依赖”，如子函数、数据库连接等</p>
<ul>
<li>提高代码的复用率</li>
<li>共享数据库的连接</li>
<li>增强安全、认证和角色管理</li>
</ul>
<table>
<thead>
<tr>
<th>​<strong>依赖类型</strong>​</th>
<th>​<strong>适用场景</strong>​</th>
<th>​<strong>优势</strong>​</th>
</tr>
</thead>
<tbody><tr>
<td>函数依赖</td>
<td>简单参数解析或逻辑复用</td>
<td>轻量级，易于测试</td>
</tr>
<tr>
<td>类依赖</td>
<td>封装复杂逻辑或状态</td>
<td>面向对象，支持属性访问</td>
</tr>
<tr>
<td>子依赖</td>
<td>构建多层依赖链</td>
<td>提高代码复用率</td>
</tr>
<tr>
<td>路径装饰器依赖</td>
<td>路由级别的统一校验（如鉴权）</td>
<td>不污染路由函数参数</td>
</tr>
<tr>
<td>全局依赖</td>
<td>应用或路由组的全局处理</td>
<td>统一管理跨路由逻辑</td>
</tr>
<tr>
<td>带资源的依赖（yield）</td>
<td>资源管理（如数据库、文件句柄）</td>
<td>确保资源正确释放，避免内存泄漏</td>
</tr>
</tbody></table>
<p><span style="color: #9c88ff; font-weight: 550;">核心特性</span></p>
<ol>
<li>​<strong>解耦与复用</strong>：将共享逻辑（如鉴权、数据库连接）抽离为依赖项。</li>
<li>​<strong>请求上下文感知</strong>：自动解析请求参数（如 <code>Header</code>, <code>Query</code>）。</li>
<li>​<strong>依赖链</strong>：支持多层嵌套，依赖项按需执行。</li>
<li>​<strong>缓存控制</strong>：通过 <code>use_cache</code> 优化性能，避免重复计算。</li>
<li>​<strong>资源管理</strong>：通过 <code>yield</code> 确保资源清理。</li>
</ol>
<h2 id="1-基本依赖声明与使用"><a href="#1-基本依赖声明与使用" class="headerlink" title="1 基本依赖声明与使用"></a>1 基本依赖声明与使用</h2><ul>
<li><strong>功能</strong>：定义可复用的依赖项，在路由函数中注入。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">common_parameters</span>(<span class="params">q: <span class="built_in">str</span> = <span class="literal">None</span>, page: <span class="built_in">int</span> = <span class="number">1</span>, limit: <span class="built_in">int</span> = <span class="number">100</span></span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;q&quot;</span>: q, <span class="string">&quot;page&quot;</span>: page, <span class="string">&quot;limit&quot;</span>: limit&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@app05.get(<span class="params"><span class="string">&quot;/dependency01&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">dependency01</span>(<span class="params">commons: <span class="built_in">dict</span> = Depends(<span class="params">common_parameters</span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> commons</span><br></pre></td></tr></table></figure>

<ul>
<li>使用 <code>Depends()</code> 声明依赖项，参数为依赖函数/类。</li>
<li>依赖项可以是 <code>async def</code> 或普通 <code>def</code> 函数。</li>
<li><strong>依赖项返回值会自动注入到路由函数的参数中</strong>。</li>
</ul>
<p><img src="https://picgocloud.oss-cn-shanghai.aliyuncs.com/picgo/20250301143022.png" alt="image.png"></p>
<h2 id="2-类作为依赖项"><a href="#2-类作为依赖项" class="headerlink" title="2 类作为依赖项"></a>2 类作为依赖项</h2><p> <strong>功能</strong>: 用类封装复杂依赖逻辑，支持初始化参数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 模拟数据库</span></span><br><span class="line">fake_items_db = [&#123;<span class="string">&quot;item_name&quot;</span>: <span class="string">&quot;Foo&quot;</span>&#125;, &#123;<span class="string">&quot;item_name&quot;</span>: <span class="string">&quot;Bar&quot;</span>&#125;, &#123;<span class="string">&quot;item_name&quot;</span>: <span class="string">&quot;Baz&quot;</span>&#125;]</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CommonQueryParams</span>:  </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, q: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>, page: <span class="built_in">int</span> = <span class="number">1</span>, limit: <span class="built_in">int</span> = <span class="number">100</span></span>):  </span><br><span class="line">        <span class="variable language_">self</span>.q = q  </span><br><span class="line">        <span class="variable language_">self</span>.page = page  </span><br><span class="line">        <span class="variable language_">self</span>.limit = limit</span><br><span class="line"></span><br><span class="line"><span class="meta">@app05.get(<span class="params"><span class="string">&quot;/classes_as_dependencies&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># async def classes_as_dependencies(commons: CommonQueryParams = Depends(CommonQueryParams)):  </span></span><br><span class="line"><span class="comment"># async def classes_as_dependencies(commons: CommonQueryParams = Depends()):</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">classes_as_dependencies</span>(<span class="params">commons = Depends(<span class="params">CommonQueryParams</span>)</span>):</span><br><span class="line">	response = &#123;&#125;  </span><br><span class="line">	<span class="keyword">if</span> commons.q:  </span><br><span class="line">	    response.update(&#123;<span class="string">&quot;q&quot;</span>: commons.q&#125;)  </span><br><span class="line">	items = fake_items_db[commons.page: commons.page + commons.limit]  </span><br><span class="line">	response.update(&#123;<span class="string">&quot;items&quot;</span>: items&#125;)  </span><br><span class="line">	<span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>

<ul>
<li>类依赖的 <code>__init__</code> 方法参数<strong>自动从请求中解析</strong>（类似路由函数）。</li>
<li>可通过 <code>commons.q</code> 直接访问类属性。</li>
</ul>
<p><img src="https://picgocloud.oss-cn-shanghai.aliyuncs.com/picgo/20250301144715.png" alt="image.png"></p>
<h2 id="3-子依赖（嵌套依赖）"><a href="#3-子依赖（嵌套依赖）" class="headerlink" title="3 子依赖（嵌套依赖）"></a>3 子依赖（嵌套依赖）</h2><p> <strong>功能</strong>：构建依赖链，实现逻辑复用。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">query</span>(<span class="params">q: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">return</span> q</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sub_query</span>(<span class="params">q: <span class="built_in">str</span> = Depends(<span class="params">query</span>), last_query: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> q:</span><br><span class="line">        <span class="keyword">return</span> last_query</span><br><span class="line">    <span class="keyword">return</span> q</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app05.get(<span class="params"><span class="string">&quot;/sub_dependency&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">sub_dependency</span>(<span class="params">final_query: <span class="built_in">str</span> = Depends(<span class="params">sub_query, use_cache=<span class="literal">True</span></span>)</span>):</span><br><span class="line">    <span class="comment"># use_cache默认是True, 表示当多个依赖有一个共同的子依赖时，</span></span><br><span class="line">    <span class="comment"># 每次request请求只会调用子依赖一次，多次调用将从缓存中获取</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;sub_dependency&quot;</span>: final_query&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>依赖项可以嵌套其他依赖项</strong>（如 <code>sub_query</code> 依赖 <code>query</code>）。</li>
<li><code>use_cache=True</code>（默认）启用缓存，同一请求中相同依赖只执行一次。</li>
</ul>
<p><img src="https://picgocloud.oss-cn-shanghai.aliyuncs.com/picgo/20250301145122.png" alt="image.png"></p>
<h2 id="4-路径装饰器中的依赖"><a href="#4-路径装饰器中的依赖" class="headerlink" title="4 路径装饰器中的依赖"></a>4 路径装饰器中的依赖</h2><p>​<strong>功能</strong>：在路由级别声明依赖（如权限校验）。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">verify_token</span>(<span class="params">x_token: <span class="built_in">str</span> = Header(<span class="params">...</span>)</span>):  </span><br><span class="line">    <span class="string">&quot;&quot;&quot;没有返回值的子依赖&quot;&quot;&quot;</span>  </span><br><span class="line">    <span class="keyword">if</span> x_token != <span class="string">&quot;fake-super-secret-token&quot;</span>:  </span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">400</span>, detail=<span class="string">&quot;X-Token header invalid&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">verify_key</span>(<span class="params">x_key: <span class="built_in">str</span> = Header(<span class="params">...</span>)</span>):  </span><br><span class="line">    <span class="string">&quot;&quot;&quot;有返回值的子依赖，但是返回值不会被调用&quot;&quot;&quot;</span>  </span><br><span class="line">    <span class="keyword">if</span> x_key != <span class="string">&quot;fake-super-secret-key&quot;</span>:  </span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">400</span>, detail=<span class="string">&quot;X-Key header invalid&quot;</span>)  </span><br><span class="line">    <span class="keyword">return</span> x_key  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># 这时候不是在函数参数中调用依赖，而是在路径操作中  </span></span><br><span class="line"><span class="meta">@app05.get(<span class="params"><span class="string">&quot;/dependency_in_path_operation&quot;</span>, dependencies=[Depends(<span class="params">verify_token</span>), Depends(<span class="params">verify_key</span>)]</span>)  </span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">dependency_in_path_operation</span>():  </span><br><span class="line">    <span class="keyword">return</span> [&#123;<span class="string">&quot;user&quot;</span>: <span class="string">&quot;user01&quot;</span>&#125;, &#123;<span class="string">&quot;user&quot;</span>: <span class="string">&quot;user02&quot;</span>&#125;]</span><br></pre></td></tr></table></figure>

<ul>
<li>通过 <code>dependencies</code> 参数在装饰器中声明依赖。</li>
<li><strong>适用于无需向路由函数传递数据的场景（如鉴权）</strong>。</li>
<li><strong>多个依赖按顺序执行</strong>，任一失败会终止请求。</li>
</ul>
<p><img src="https://picgocloud.oss-cn-shanghai.aliyuncs.com/picgo/20250301145421.png" alt="image.png|775"></p>
<h2 id="5-全局依赖"><a href="#5-全局依赖" class="headerlink" title="5 全局依赖"></a>5 全局依赖</h2><p><strong>功能</strong>：将依赖应用到整个 <code>APIRouter</code> 或 <code>FastAPI</code> 实例。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app05 = APIRouter(dependencies=[Depends(verify_token)])  <span class="comment"># 所有路由生效</span></span><br></pre></td></tr></table></figure>

<ul>
<li>适用于跨路由的统一处理（如全局身份验证）。</li>
<li>优先级低于路由装饰器中的 <code>dependencies</code>。</li>
</ul>
<h2 id="6-带资源的依赖（yield）​"><a href="#6-带资源的依赖（yield）​" class="headerlink" title="6 带资源的依赖（yield）​"></a>6 带资源的依赖（yield）​</h2><p> <strong>功能</strong>：管理需要清理的资源（如数据库连接）。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_db</span>():</span><br><span class="line">    db = <span class="string">&quot;db_connection&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">yield</span> db  <span class="comment"># 路由执行前获取资源</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Closing DB&quot;</span>)  <span class="comment"># 路由执行后清理资源</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app05.get(<span class="params"><span class="string">&quot;/db_operation&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">db_operation</span>(<span class="params">db: <span class="built_in">str</span> = Depends(<span class="params">get_db</span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;db_status&quot;</span>: db&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>使用 <code>yield</code> 替代 <code>return</code>，<code>yield</code> 后的代码是清理逻辑。</li>
<li>支持异步上下文管理（如 <code>async with</code>）。</li>
</ul>
<h1 id="安全、认证和授权"><a href="#安全、认证和授权" class="headerlink" title="安全、认证和授权"></a>安全、认证和授权</h1><h2 id="1-OAuth2-认证"><a href="#1-OAuth2-认证" class="headerlink" title="1 OAuth2 认证"></a>1 OAuth2 认证</h2><h3 id="1-1-OAuth2-密码模式（Password-Grant）"><a href="#1-1-OAuth2-密码模式（Password-Grant）" class="headerlink" title="1.1 OAuth2 密码模式（Password Grant）"></a>1.1 OAuth2 密码模式（Password Grant）</h3><p>OAuth2 密码模式（Resource Owner Password Credentials Grant）允许客户端直接使用用户的账号密码换取访问令牌（Access Token）。它适用于高度信任的客户端（如自家开发的移动应用或前端），但需谨慎使用，因为用户需明文传递密码。</p>
<ol>
<li>​<strong>用户提供凭据</strong>：客户端收集用户的 <code>username</code> 和 <code>password</code>。</li>
<li>​<strong>请求令牌</strong>：客户端发送凭据到令牌端点（<code>/token</code>）。</li>
<li>​<strong>返回令牌</strong>：服务端验证凭据，返回 <code>access_token</code>。</li>
<li>​<strong>访问资源</strong>：客户端使用 <code>access_token</code> 调用受保护的 API。</li>
</ol>
<p>用户登录 → 发放令牌 → 令牌验证 → 保护 API</p>
<h3 id="1-2-​FastAPI-的-OAuth2PasswordBearer"><a href="#1-2-​FastAPI-的-OAuth2PasswordBearer" class="headerlink" title="1.2 ​FastAPI 的 OAuth2PasswordBearer"></a>1.2 ​FastAPI 的 <code>OAuth2PasswordBearer</code></h3><p><code>OAuth2PasswordBearer</code> 是 FastAPI 提供的工具类，用于从请求的 <code>Authorization</code> 头中提取 <code>Bearer Token</code>，并自动处理 OAuth2 的认证流程。</p>
<ul>
<li>​<strong>自动解析请求头</strong>：提取 <code>Authorization: Bearer &lt;token&gt;</code> 中的令牌。</li>
<li>​<strong>集成依赖注入系统</strong>：作为依赖项验证令牌是否合法。</li>
<li>​<strong>定义令牌端点</strong>：通过 <code>tokenUrl</code> 参数指定令牌发放的 URL（如 <code>/token</code>）。</li>
</ul>
<h3 id="1-3-基于-Password-和-Bearer-token-的-OAuth2-认证"><a href="#1-3-基于-Password-和-Bearer-token-的-OAuth2-认证" class="headerlink" title="1.3 基于 Password 和 Bearer token 的 OAuth2 认证"></a>1.3 基于 Password 和 Bearer token 的 OAuth2 认证</h3><figure class="highlight python"><figcaption><span>fold</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;OAuth2 密码模式和 FastAPI 的 OAuth2PasswordBearer&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">oauth2_schema = OAuth2PasswordBearer(tokenUrl=<span class="string">&quot;/chapter06/token&quot;</span>) </span><br><span class="line">  </span><br><span class="line"><span class="meta">@app06.get(<span class="params"><span class="string">&quot;/oauth2_password_bearer&quot;</span></span>)  </span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">oauth2_password_bearer</span>(<span class="params">token: <span class="built_in">str</span> = Depends(<span class="params">oauth2_schema</span>)</span>):  </span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;token&quot;</span>: token&#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">基于 Password 和 Bearer token 的 OAuth2 认证完整实现</span></span><br><span class="line"><span class="string">本模块演示了 FastAPI 如何实现 OAuth2 密码模式认证流程</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 模拟用户数据库</span></span><br><span class="line">fake_users_db = &#123;</span><br><span class="line">    <span class="string">&quot;john snow&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;username&quot;</span>: <span class="string">&quot;john snow&quot;</span>,</span><br><span class="line">        <span class="string">&quot;full_name&quot;</span>: <span class="string">&quot;John Snow&quot;</span>,</span><br><span class="line">        <span class="string">&quot;email&quot;</span>: <span class="string">&quot;johnsnow@example.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;hashed_password&quot;</span>: <span class="string">&quot;fakehashedsecret&quot;</span>,  <span class="comment"># 模拟加密后的密码（实际应使用安全哈希算法）</span></span><br><span class="line">        <span class="string">&quot;disabled&quot;</span>: <span class="literal">False</span>,  <span class="comment"># 账户是否禁用（权限控制）</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;alice&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;username&quot;</span>: <span class="string">&quot;alice&quot;</span>,</span><br><span class="line">        <span class="string">&quot;full_name&quot;</span>: <span class="string">&quot;Alice Wonderson&quot;</span>,</span><br><span class="line">        <span class="string">&quot;email&quot;</span>: <span class="string">&quot;alice@example.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;hashed_password&quot;</span>: <span class="string">&quot;fakehashedsecret2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;disabled&quot;</span>: <span class="literal">True</span>,  <span class="comment"># 该账户已被禁用</span></span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fake_hash_password</span>(<span class="params">password: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;模拟密码哈希过程（仅用于演示，实际必须使用安全哈希算法如bcrypt）</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    参数:</span></span><br><span class="line"><span class="string">    password -- 原始密码字符串</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    返回:</span></span><br><span class="line"><span class="string">    模拟的哈希字符串（实际场景需要真正的加密哈希）</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;fakehashed&quot;</span> + password  <span class="comment"># 简单拼接模拟哈希</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;用户基本信息模型（API响应模型）</span></span><br><span class="line"><span class="string">    用于返回给客户端的安全用户信息，排除敏感字段如密码&quot;&quot;&quot;</span></span><br><span class="line">    username: <span class="built_in">str</span></span><br><span class="line">    email: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>  <span class="comment"># 可选字段</span></span><br><span class="line">    full_name: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line">    disabled: <span class="type">Optional</span>[<span class="built_in">bool</span>] = <span class="literal">None</span>  <span class="comment"># 账户状态</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserInDB</span>(<span class="title class_ inherited__">User</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;数据库用户模型（继承用户基础模型）</span></span><br><span class="line"><span class="string">    包含敏感的安全字段，仅用于服务器端存储&quot;&quot;&quot;</span></span><br><span class="line">    hashed_password: <span class="built_in">str</span>  <span class="comment"># 存储加密后的密码</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app06.post(<span class="params"><span class="string">&quot;/token&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">login</span>(<span class="params">form_data: OAuth2PasswordRequestForm = Depends(<span class="params"></span>)</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;OAuth2 令牌获取端点</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    流程:</span></span><br><span class="line"><span class="string">    1. 接收客户端提交的用户名和密码</span></span><br><span class="line"><span class="string">    2. 验证用户凭证</span></span><br><span class="line"><span class="string">    3. 返回访问令牌</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    参数:</span></span><br><span class="line"><span class="string">    form_data -- 自动解析的OAuth2表单数据</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    返回:</span></span><br><span class="line"><span class="string">    包含访问令牌和类型的JSON响应</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    异常:</span></span><br><span class="line"><span class="string">    HTTP 400 - 用户名或密码错误</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 在模拟数据库中查找用户</span></span><br><span class="line">    user_dict = fake_users_db.get(form_data.username)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user_dict:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(</span><br><span class="line">            status_code=status.HTTP_400_BAD_REQUEST,</span><br><span class="line">            detail=<span class="string">&quot;用户名或密码错误&quot;</span></span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 将数据库数据转换为Pydantic模型</span></span><br><span class="line">    user = UserInDB(**user_dict)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 模拟密码哈希验证（实际应对比哈希值）</span></span><br><span class="line">    hashed_password = fake_hash_password(form_data.password)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> hashed_password == user.hashed_password:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(</span><br><span class="line">            status_code=status.HTTP_400_BAD_REQUEST,</span><br><span class="line">            detail=<span class="string">&quot;用户名或密码错误&quot;</span></span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 返回访问令牌（此处简单返回用户名，实际应生成JWT）</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&quot;access_token&quot;</span>: user.username,  <span class="comment"># 实际应生成加密令牌</span></span><br><span class="line">        <span class="string">&quot;token_type&quot;</span>: <span class="string">&quot;bearer&quot;</span>         <span class="comment"># Bearer令牌类型</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">db, username: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;从数据库获取用户信息</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    参数:</span></span><br><span class="line"><span class="string">    db -- 用户数据库字典</span></span><br><span class="line"><span class="string">    username -- 要查找的用户名</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    返回:</span></span><br><span class="line"><span class="string">    UserInDB实例 | None</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> username <span class="keyword">in</span> db:</span><br><span class="line">        user_dict = db[username]</span><br><span class="line">        <span class="keyword">return</span> UserInDB(**user_dict)  <span class="comment"># 转换为Pydantic模型</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fake_decode_token</span>(<span class="params">token: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;模拟令牌解码过程（实际应验证加密令牌）</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    参数:</span></span><br><span class="line"><span class="string">    token -- 客户端提交的访问令牌</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    返回:</span></span><br><span class="line"><span class="string">    用户信息 | None</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> get_user(fake_users_db, token)  <span class="comment"># 直接使用令牌作为用户名查询</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_current_user</span>(<span class="params">token: <span class="built_in">str</span> = Depends(<span class="params">oauth2_schema</span>)</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;获取当前认证用户依赖项</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    流程:</span></span><br><span class="line"><span class="string">    1. 从请求头提取Bearer令牌</span></span><br><span class="line"><span class="string">    2. 解码令牌获取用户信息</span></span><br><span class="line"><span class="string">    3. 验证用户是否存在</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    参数:</span></span><br><span class="line"><span class="string">    token -- 依赖注入的访问令牌</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    返回:</span></span><br><span class="line"><span class="string">    用户信息</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    异常:</span></span><br><span class="line"><span class="string">    HTTP 401 - 无效的认证凭证</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    user = fake_decode_token(token)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">        <span class="comment"># 根据OAuth2规范，在header中添加WWW-Authenticate信息</span></span><br><span class="line">        <span class="keyword">raise</span> HTTPException(</span><br><span class="line">            status_code=status.HTTP_401_UNAUTHORIZED,</span><br><span class="line">            detail=<span class="string">&quot;无效的认证凭证&quot;</span>,</span><br><span class="line">            headers=&#123;<span class="string">&quot;WWW-Authenticate&quot;</span>: <span class="string">&quot;Bearer&quot;</span>&#125;,</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">return</span> user</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_current_active_user</span>(<span class="params">current_user: User = Depends(<span class="params">get_current_user</span>)</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;验证用户状态依赖项</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    参数:</span></span><br><span class="line"><span class="string">    current_user -- 当前认证用户</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    返回:</span></span><br><span class="line"><span class="string">    激活用户信息</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    异常:</span></span><br><span class="line"><span class="string">    HTTP 400 - 账户已被禁用</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> current_user.disabled:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(</span><br><span class="line">            status_code=status.HTTP_400_BAD_REQUEST,</span><br><span class="line">            detail=<span class="string">&quot;非活跃用户&quot;</span></span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">return</span> current_user  <span class="comment"># 返回通过状态检查的用户</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app06.get(<span class="params"><span class="string">&quot;/users/me&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_users_me</span>(<span class="params">current_user: User = Depends(<span class="params">get_current_active_user</span>)</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;获取当前用户信息的受保护端点</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    流程:</span></span><br><span class="line"><span class="string">    1. 通过依赖链验证令牌有效性</span></span><br><span class="line"><span class="string">    2. 验证用户账户状态</span></span><br><span class="line"><span class="string">    3. 返回安全过滤后的用户信息</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    返回:</span></span><br><span class="line"><span class="string">    用户基本信息（User模型，不含敏感字段）</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> current_user  <span class="comment"># 返回Pydantic模型会自动过滤敏感字段</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">oauth2_schema = OAuth2PasswordBearer(tokenUrl=<span class="string">&quot;/chapter06/token&quot;</span>) </span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_users_me</span>(<span class="params">current_user: User = Depends(<span class="params">get_current_active_user</span>)</span>) <span class="comment"># 上上层</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_current_user</span>(<span class="params">token: <span class="built_in">str</span> = Depends(<span class="params">oauth2_schema</span>)</span>) <span class="comment"># 注入了 `oauth2_schema` 的依赖</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><code>oauth2_schema = OAuth2PasswordBearer(tokenUrl=&quot;/chapter06/token&quot;) </code> 指定了从哪个路由里解析 <code>token</code></li>
<li>这个 <code>token</code> 就是 <code>oauth2_schema</code> 这里依赖从请求头里解析出来的</li>
</ul>
<p>故需要先锁一下，获取 token 才能测试该接口</p>
<p><img src="https://picgocloud.oss-cn-shanghai.aliyuncs.com/picgo/20250301161819.png" alt="image.png"></p>
<h2 id="2-JWT-认证"><a href="#2-JWT-认证" class="headerlink" title="2 JWT 认证"></a>2 <code>JWT</code> 认证</h2><p>OAuth2 with Password (and hashing), Bearer with JWT tokens 开发基于 JSON Web Tokens 的认证</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">    participant Client</span><br><span class="line">    participant Server</span><br><span class="line">    Client-&gt;&gt;Server: POST /jwt/token (username, password)</span><br><span class="line">    Server-&gt;&gt;Server: 验证用户密码</span><br><span class="line">    Server-&gt;&gt;Server: 生成 JWT（含 sub 和 exp）</span><br><span class="line">    Server--&gt;&gt;Client: 返回 access_token</span><br><span class="line">    Client-&gt;&gt;Server: GET /jwt/users/me (Bearer access_token)</span><br><span class="line">    Server-&gt;&gt;Server: 解码 JWT，验证签名和有效期</span><br><span class="line">    Server-&gt;&gt;Server: 查询用户信息</span><br><span class="line">    Server--&gt;&gt;Client: 返回用户数据</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><figcaption><span>fold</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 更新模拟的用户数据库，使用bcrypt加密后的密码</span></span><br><span class="line">fake_users_db.update(&#123;</span><br><span class="line">    <span class="string">&quot;john snow&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;username&quot;</span>: <span class="string">&quot;john snow&quot;</span>,</span><br><span class="line">        <span class="string">&quot;full_name&quot;</span>: <span class="string">&quot;John Snow&quot;</span>,</span><br><span class="line">        <span class="string">&quot;email&quot;</span>: <span class="string">&quot;johnsnow@example.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;hashed_password&quot;</span>: <span class="string">&quot;$2b$12$EixZaYVK1fsbw1ZfbX3OXePaWxn96p36WQoeG6Lruj3vjPGga31lW&quot;</span>,  <span class="comment"># 使用bcrypt加密后的密码</span></span><br><span class="line">        <span class="string">&quot;disabled&quot;</span>: <span class="literal">False</span>,  <span class="comment"># 是否有权限</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 密钥，用于JWT的签名</span></span><br><span class="line">SECRET_KEY = <span class="string">&quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;</span>  <span class="comment"># 生成密钥 openssl rand -hex 32</span></span><br><span class="line"><span class="comment"># JWT算法</span></span><br><span class="line">ALGORITHM = <span class="string">&quot;HS256&quot;</span></span><br><span class="line"><span class="comment"># 访问令牌过期时间（分钟）</span></span><br><span class="line">ACCESS_TOKEN_EXPIRE_MINUTES = <span class="number">30</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义Pydantic模型，用于返回给用户的Token</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Token</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;返回给用户的Token&quot;&quot;&quot;</span></span><br><span class="line">    access_token: <span class="built_in">str</span></span><br><span class="line">    token_type: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义密码上下文，使用bcrypt进行密码哈希</span></span><br><span class="line">pwd_context = CryptContext(schemes=[<span class="string">&quot;bcrypt&quot;</span>], deprecated=<span class="string">&quot;auto&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义OAuth2PasswordBearer实例，指定请求Token的URL地址</span></span><br><span class="line">oauth2_schema = OAuth2PasswordBearer(tokenUrl=<span class="string">&quot;/chapter06/jwt/token&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对密码进行校验</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">verity_password</span>(<span class="params">plain_password: <span class="built_in">str</span>, hashed_password: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;对密码进行校验&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> pwd_context.verify(plain_password, hashed_password)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从数据库中获取用户信息</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">jwt_get_user</span>(<span class="params">db, username: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">if</span> username <span class="keyword">in</span> db:</span><br><span class="line">        user_dict = db[username]</span><br><span class="line">        <span class="keyword">return</span> UserInDB(**user_dict)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 认证用户</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">jwt_authenticate_user</span>(<span class="params">db, username: <span class="built_in">str</span>, password: <span class="built_in">str</span></span>):</span><br><span class="line">    user = jwt_get_user(db=db, username=username)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> verity_password(plain_password=password, hashed_password=user.hashed_password):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> user</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建访问令牌</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_access_token</span>(<span class="params">data: <span class="built_in">dict</span>, expires_delta: <span class="type">Optional</span>[timedelta] = <span class="literal">None</span></span>):</span><br><span class="line">    to_encode = data.copy()</span><br><span class="line">    <span class="keyword">if</span> expires_delta:</span><br><span class="line">        expire = datetime.utcnow() + expires_delta</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        expire = datetime.utcnow() + timedelta(minutes=<span class="number">15</span>)</span><br><span class="line">    to_encode.update(&#123;<span class="string">&quot;exp&quot;</span>: expire&#125;)</span><br><span class="line">    encoded_jwt = jwt.encode(claims=to_encode, key=SECRET_KEY, algorithm=ALGORITHM)</span><br><span class="line">    <span class="keyword">return</span> encoded_jwt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义一个路由，用于处理登录请求并返回JWT访问令牌</span></span><br><span class="line"><span class="meta">@app06.post(<span class="params"><span class="string">&quot;/jwt/token&quot;</span>, response_model=Token</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">login_for_access_token</span>(<span class="params">form_data: OAuth2PasswordRequestForm = Depends(<span class="params"></span>)</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    OAuth2 令牌获取端点 (使用JWT)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    流程:</span></span><br><span class="line"><span class="string">    1. 接收客户端提交的用户名和密码</span></span><br><span class="line"><span class="string">    2. 验证用户凭证</span></span><br><span class="line"><span class="string">    3. 生成并返回JWT访问令牌</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    参数:</span></span><br><span class="line"><span class="string">    form_data -- 自动解析的OAuth2表单数据</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    返回:</span></span><br><span class="line"><span class="string">    包含JWT访问令牌和类型的JSON响应</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    异常:</span></span><br><span class="line"><span class="string">    HTTP 401 - 用户名或密码错误</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 认证用户</span></span><br><span class="line">    user = jwt_authenticate_user(db=fake_users_db, username=form_data.username, password=form_data.password)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(</span><br><span class="line">            status.HTTP_401_UNAUTHORIZED,</span><br><span class="line">            detail=<span class="string">&quot;Incorrect username or password&quot;</span>,</span><br><span class="line">            headers=&#123;<span class="string">&quot;WWW-Authenticate&quot;</span>: <span class="string">&quot;Bearer&quot;</span>&#125;,</span><br><span class="line">        )</span><br><span class="line">    <span class="comment"># 设置访问令牌的过期时间</span></span><br><span class="line">    access_token_expires = timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)</span><br><span class="line">    <span class="comment"># 创建JWT访问令牌</span></span><br><span class="line">    access_token = create_access_token(</span><br><span class="line">        data=&#123;<span class="string">&quot;sub&quot;</span>: user.username&#125;, expires_delta=access_token_expires</span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># 返回JWT访问令牌和令牌类型</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;access_token&quot;</span>: access_token, <span class="string">&quot;token_type&quot;</span>: <span class="string">&quot;bearer&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从请求头中获取当前用户（使用JWT）</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">jwt_get_current_user</span>(<span class="params">token: <span class="built_in">str</span> = Depends(<span class="params">oauth2_schema</span>)</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    从请求头中提取并验证JWT Token，获取当前用户</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    流程:</span></span><br><span class="line"><span class="string">    1. 提取请求头中的Authorization头信息</span></span><br><span class="line"><span class="string">    2. 解码JWT Token</span></span><br><span class="line"><span class="string">    3. 验证Token的有效性</span></span><br><span class="line"><span class="string">    4. 返回用户信息</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    参数:</span></span><br><span class="line"><span class="string">    token -- 从Authorization头中提取的Bearer Token</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    返回:</span></span><br><span class="line"><span class="string">    当前用户信息</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    异常:</span></span><br><span class="line"><span class="string">    HTTP 401 - 无法验证凭证</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    credentials_exception = HTTPException(</span><br><span class="line">        status.HTTP_401_UNAUTHORIZED,</span><br><span class="line">        detail=<span class="string">&quot;Could not validate credentials&quot;</span>,</span><br><span class="line">        headers=&#123;<span class="string">&quot;WWW-Authenticate&quot;</span>: <span class="string">&quot;Bearer&quot;</span>&#125;,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 解码JWT Token</span></span><br><span class="line">        payload = jwt.decode(token=token, key=SECRET_KEY, algorithms=[ALGORITHM])</span><br><span class="line">        username = payload.get(<span class="string">&quot;sub&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> username <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> credentials_exception</span><br><span class="line">    <span class="keyword">except</span> JWTError:</span><br><span class="line">        <span class="keyword">raise</span> credentials_exception</span><br><span class="line">    <span class="comment"># 从数据库中获取用户信息</span></span><br><span class="line">    user = jwt_get_user(db=fake_users_db, username=username)</span><br><span class="line">    <span class="keyword">if</span> user <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> credentials_exception</span><br><span class="line">    <span class="keyword">return</span> user</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取当前活跃用户（使用JWT）</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">jwt_get_current_active_user</span>(<span class="params">current_user: User = Depends(<span class="params">jwt_get_current_user</span>)</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    获取当前活跃用户（使用JWT）</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    流程:</span></span><br><span class="line"><span class="string">    1. 调用jwt_get_current_user获取当前用户</span></span><br><span class="line"><span class="string">    2. 检查用户是否被禁用</span></span><br><span class="line"><span class="string">    3. 返回当前活跃用户</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    参数:</span></span><br><span class="line"><span class="string">    current_user -- 当前用户信息</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    返回:</span></span><br><span class="line"><span class="string">    当前活跃用户信息</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    异常:</span></span><br><span class="line"><span class="string">    HTTP 400 - 不活跃用户</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> current_user.disabled:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail=<span class="string">&quot;Inactive user&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> current_user</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义一个路由，用于获取当前登录用户的详细信息（使用JWT）</span></span><br><span class="line"><span class="meta">@app06.get(<span class="params"><span class="string">&quot;/jwt/users/me&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">jwt_read_users_me</span>(<span class="params">current_user: User = Depends(<span class="params">jwt_get_current_active_user</span>)</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    获取当前登录用户的详细信息（使用JWT）</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    流程:</span></span><br><span class="line"><span class="string">    1. 调用jwt_get_current_active_user获取当前活跃用户</span></span><br><span class="line"><span class="string">    2. 返回当前用户的详细信息</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    参数:</span></span><br><span class="line"><span class="string">    current_user -- 当前活跃用户信息</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    返回:</span></span><br><span class="line"><span class="string">    当前用户的详细信息</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> current_user</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>使用 <code>jwt.encode</code> 生成包含签名和过期时间的令牌，确保令牌的安全性和完整性。</li>
<li>使用 <code>jwt.decode</code> 验证令牌的签名和有效期，确保令牌未被篡改且未过期。</li>
<li>依赖项 <code>jwt_get_current_user</code> 负责解码和验证 JWT 令牌，并提取用户信息。</li>
</ul>
<p><img src="https://picgocloud.oss-cn-shanghai.aliyuncs.com/picgo/20250301163559.png" alt="image.png"></p>
<h2 id="3-Security权限验证"><a href="#3-Security权限验证" class="headerlink" title="3 Security权限验证"></a>3 <code>Security</code>权限验证</h2><p>在 FastAPI 中，<code>Security</code> 是用于定义和处理 API 端点安全机制的一个重要工具。它通常与依赖注入（Dependency Injection）系统结合使用，以实现各种身份验证和授权策略，如 OAuth2、API 密钥、HTTP 基本认证等。<code>Security</code> 允许开发者轻松地在路径操作函数（route operation functions）或依赖项中声明安全要求，从而确保只有经过验证和授权的用户才能访问特定的资源。</p>
<p><span style="color: #badc58; font-weight: 550;">主要功能：</span></p>
<ol>
<li>​<strong>声明安全需求</strong>：通过在路径操作函数或依赖项中使用 <code>Security</code>，可以明确指定访问该端点所需的安全机制。</li>
<li>​<strong>依赖注入</strong>：<code>Security</code> 与 FastAPI 的依赖注入系统无缝集成，使得安全验证逻辑可以被重用和维护。</li>
<li>​<strong>自动文档生成</strong>：使用 <code>Security</code> 可以让 FastAPI 自动生成交互式 API 文档（如 Swagger UI 和 ReDoc），展示所需的安全认证方式，方便开发者测试和使用 API。</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> APIRouter, Security</span><br><span class="line"><span class="keyword">from</span> fastapi.security <span class="keyword">import</span> SecurityScopes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个API路由器实例</span></span><br><span class="line">app01 = APIRouter()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 权限校验函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_scopes</span>(<span class="params">security_scopes: SecurityScopes</span>):</span><br><span class="line">    <span class="built_in">print</span>(security_scopes.scopes)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 管理员路由</span></span><br><span class="line"><span class="meta">@app01.get(<span class="params">path=<span class="string">&quot;/group/admin&quot;</span>, dependencies=[Security(<span class="params">print_scopes, scopes=[<span class="string">&quot;admin&quot;</span>]</span>)]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">group_admin</span>():</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户路由</span></span><br><span class="line"><span class="meta">@app01.get(<span class="params">path=<span class="string">&quot;/group/user&quot;</span>, dependencies=[Security(<span class="params">print_scopes, scopes=[<span class="string">&quot;users&quot;</span>]</span>)]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">group_user</span>():</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 访客路由</span></span><br><span class="line"><span class="meta">@app01.get(<span class="params"> path=<span class="string">&quot;/guest&quot;</span>,dependencies=[Security(<span class="params">print_scopes, scopes=[<span class="string">&quot;guest&quot;</span>]</span>)]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">guest</span>():</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>Security</code>：用于声明安全依赖项（如权限验证）。</li>
<li><code>SecurityScopes</code>：存储当前请求所需的安全作用域（Scopes）</li>
</ul>
<ol>
<li>​<strong>SecurityScopes</strong>：<ul>
<li>存储当前路由的安全作用域（如 <code>[&quot;admin&quot;]</code>）。</li>
<li>通过依赖注入传递到 <code>print_scopes</code> 函数中，开发者可以在此处实现具体的权限校验逻辑。</li>
</ul>
</li>
<li>​<strong>Security 依赖</strong>：<ul>
<li><code>Security(print_scopes, scopes=[&quot;admin&quot;])</code> 表示将 <code>print_scopes</code> 作为依赖项，并指定该路由需要的作用域。</li>
<li>当用户访问路由时，FastAPI 会先执行依赖项 <code>print_scopes</code>，再处理请求。</li>
</ul>
</li>
<li>​<strong>Dependencies 参数</strong>：<ul>
<li>路由的 <code>dependencies</code> 列表中可以包含多个依赖项，它们会在路由处理前依次执行。</li>
<li>如果依赖项抛出异常（如权限不足），请求会被终止。</li>
</ul>
</li>
</ol>
<p><img src="https://picgocloud.oss-cn-shanghai.aliyuncs.com/picgo/20250317094336.png" alt="image.png"></p>
<h2 id="4-RBAC-权限设计"><a href="#4-RBAC-权限设计" class="headerlink" title="4 RBAC 权限设计"></a>4 RBAC 权限设计</h2><p> <img src="https://picgocloud.oss-cn-shanghai.aliyuncs.com/picgo/20250226202618.png" alt="image.png"></p>
<h2 id="5-Session和-Cookie"><a href="#5-Session和-Cookie" class="headerlink" title="5 Session和 Cookie"></a>5 Session和 Cookie</h2><ul>
<li>​<strong>Session依赖Cookie</strong>：Session 通过唯一的 <code>Session ID</code> 标识用户，而 <code>Session ID</code> 通常存储在客户端的 Cookie 中。</li>
<li>​<strong>首次交互流程</strong>：<ol>
<li>用户首次访问 → 服务器创建 Session 并生成 <code>Session ID</code>。</li>
<li>服务器通过 HTTP 响应头 <code>Set-Cookie</code> 将 <code>Session ID</code> 发送给浏览器。</li>
<li>后续请求中，浏览器自动携带 <code>Session ID</code> Cookie → 服务器据此找到对应的 Session 数据。</li>
</ol>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app</span></span><br><span class="line"><span class="keyword">from</span> starlette.middleware.sessions <span class="keyword">import</span> SessionMiddleware</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加中间件  </span></span><br><span class="line">application.add_middleware(Middleware.BaseMiddleware)  <span class="comment"># 自定义基础中间件  </span></span><br><span class="line">  </span><br><span class="line">application.add_middleware(  </span><br><span class="line">    SessionMiddleware,  <span class="comment"># 会话管理中间件  </span></span><br><span class="line">    secret_key=settings.SECRET_KEY,  <span class="comment"># 会话密钥  </span></span><br><span class="line">    session_cookie=settings.SESSION_COOKIE,  <span class="comment"># 会话Cookie名称  </span></span><br><span class="line">    max_age=settings.SESSION_MAX_AGE  <span class="comment"># 会话最大存活时间  </span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#code.Middleware</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> time  </span><br><span class="line"><span class="keyword">from</span> starlette.datastructures <span class="keyword">import</span> MutableHeaders  </span><br><span class="line"><span class="keyword">from</span> starlette.types <span class="keyword">import</span> ASGIApp, Receive, Scope, Send, Message  </span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Request  </span><br><span class="line"><span class="keyword">from</span> core.Utils <span class="keyword">import</span> random_str  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BaseMiddleware</span>:  </span><br><span class="line">    <span class="string">&quot;&quot;&quot;  </span></span><br><span class="line"><span class="string">    基础中间件类，用于处理每个HTTP请求和响应。  </span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">    此中间件主要功能包括：  </span></span><br><span class="line"><span class="string">    - 记录请求处理时间，并将处理时间添加到响应头中。  </span></span><br><span class="line"><span class="string">    - 为每个没有会话ID的请求生成一个随机的会话ID并存储在请求会话中。  </span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>  </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, app: ASGIApp</span>) -&gt; <span class="literal">None</span>:  </span><br><span class="line">        <span class="string">&quot;&quot;&quot;  </span></span><br><span class="line"><span class="string">        初始化中间件。  </span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">        Args:            app (ASGIApp): 应用实例，通常是一个FastAPI应用。  </span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span>        <span class="variable language_">self</span>.app = app  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self, scope: Scope, receive: Receive, send: Send</span>) -&gt; <span class="literal">None</span>:  </span><br><span class="line">        <span class="string">&quot;&quot;&quot;  </span></span><br><span class="line"><span class="string">        处理每个传入的请求。  </span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">        Args:            scope (Scope): 请求的上下文信息。  </span></span><br><span class="line"><span class="string">            receive (Receive): 接收消息的异步函数。  </span></span><br><span class="line"><span class="string">            send (Send): 发送消息的异步函数。  </span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span>        <span class="keyword">if</span> scope[<span class="string">&quot;type&quot;</span>] != <span class="string">&quot;http&quot;</span>:  <span class="comment"># 非HTTP协议的请求直接传递给下一个中间件或应用  </span></span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">self</span>.app(scope, receive, send)  </span><br><span class="line">            <span class="keyword">return</span>  </span><br><span class="line">  </span><br><span class="line">        start_time = time.time()  <span class="comment"># 记录请求开始时间  </span></span><br><span class="line">        req = Request(scope, receive, send)  </span><br><span class="line">  </span><br><span class="line">        <span class="comment"># 如果请求中没有会话ID，则生成一个新的随机会话ID并存储在请求会话中  </span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> req.session.get(<span class="string">&quot;session&quot;</span>):  </span><br><span class="line">            req.session.setdefault(<span class="string">&quot;session&quot;</span>, random_str())  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">send_wrapper</span>(<span class="params">message: Message</span>) -&gt; <span class="literal">None</span>:  </span><br><span class="line">            <span class="string">&quot;&quot;&quot;  </span></span><br><span class="line"><span class="string">            包装发送函数，用于在响应时添加处理时间到响应头中。  </span></span><br><span class="line"><span class="string">            Args:                message (Message): 响应消息。  </span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span>            process_time = time.time() - start_time  <span class="comment"># 计算请求处理时间  </span></span><br><span class="line">            <span class="keyword">if</span> message[<span class="string">&quot;type&quot;</span>] == <span class="string">&quot;http.response.start&quot;</span>:  </span><br><span class="line">                headers = MutableHeaders(scope=message)  </span><br><span class="line">                headers.append(<span class="string">&quot;X-Process-Time&quot;</span>, <span class="built_in">str</span>(process_time))  <span class="comment"># 添加处理时间到响应头中  </span></span><br><span class="line">            <span class="keyword">await</span> send(message)  </span><br><span class="line">  </span><br><span class="line">        <span class="comment"># 将包装后的发送函数传递给下一个中间件或应用  </span></span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">self</span>.app(scope, receive, send_wrapper)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># views.home</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Request, Form, Cookie  </span><br><span class="line"><span class="keyword">from</span> models.base <span class="keyword">import</span> User  </span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span>  </span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">home</span>(<span class="params">request: Request, session_id: <span class="type">Optional</span>[<span class="built_in">str</span>] = Cookie(<span class="params"><span class="literal">None</span></span>)</span>):  </span><br><span class="line">    <span class="comment"># return templates.get_template(&quot;index.html&quot;).render(&#123;&quot;request&quot;: request, &quot;id&quot;: id&#125;)  </span></span><br><span class="line">    cookie = session_id  </span><br><span class="line">    session = request.session.get(<span class="string">&quot;session&quot;</span>)  </span><br><span class="line">    page_data = &#123;  </span><br><span class="line">        <span class="string">&quot;cookie&quot;</span>: cookie,  </span><br><span class="line">        <span class="string">&quot;session&quot;</span>: session  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment"># request.session.setdefault(&quot;55555&quot;, &quot;hdaldais&quot;)  </span></span><br><span class="line">    <span class="keyword">return</span> request.app.state.views.TemplateResponse(<span class="string">&quot;index.html&quot;</span>, &#123;<span class="string">&quot;request&quot;</span>: request, **page_data&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="MySQL、Redis、Minio-配置"><a href="#MySQL、Redis、Minio-配置" class="headerlink" title="MySQL、Redis、Minio 配置"></a>MySQL、Redis、Minio 配置</h1><p><img src="https://picgocloud.oss-cn-shanghai.aliyuncs.com/picgo/20250317095059.png" alt="image.png"></p>
<ul>
<li><code>database</code>：是根据默认配置，生成实例(单例模式)</li>
<li><code>models</code>：ORM 模型类，用于与数据库交互，对应数据库中的表</li>
<li><code>schemas</code>：Pydantic 模型类，用于数据校验和序列化，定义了数据的结构和约束</li>
</ul>
<h2 id="1-MySQL-配置"><a href="#1-MySQL-配置" class="headerlink" title="1 MySQL 配置"></a>1 MySQL 配置</h2><p><a target="_blank" rel="noopener" href="https://www.acwing.com/blog/content/23467/">MySQL v8.0.31——下载和安装及环境变量配置过程 - AcWing</a></p>
<p>这里使用的是 <code>Tortoise ORM</code></p>
<h3 id="1-1-根据配置生成实例"><a href="#1-1-根据配置生成实例" class="headerlink" title="1.1 根据配置生成实例"></a>1.1 根据配置生成实例</h3><p><code>database/mysql</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> tortoise <span class="keyword">import</span> Tortoise</span><br><span class="line"><span class="keyword">from</span> tortoise.contrib.fastapi <span class="keyword">import</span> register_tortoise</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment"># -----------------------数据库配置-----------------------------------</span></span><br><span class="line"><span class="comment"># 数据库ORM配置字典</span></span><br><span class="line">DB_ORM_CONFIG = &#123;</span><br><span class="line">    <span class="string">&quot;connections&quot;</span>: &#123;</span><br><span class="line">        <span class="comment"># 基础数据库连接配置</span></span><br><span class="line">        <span class="string">&quot;base&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;engine&#x27;</span>: <span class="string">&#x27;tortoise.backends.mysql&#x27;</span>,  <span class="comment"># 使用Tortoise ORM的MySQL后端</span></span><br><span class="line">            <span class="string">&quot;credentials&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;host&#x27;</span>: os.getenv(<span class="string">&#x27;BASE_HOST&#x27;</span>, <span class="string">&#x27;127.0.0.1&#x27;</span>),  <span class="comment"># 数据库主机地址，默认为本地</span></span><br><span class="line">                <span class="string">&#x27;user&#x27;</span>: os.getenv(<span class="string">&#x27;BASE_USER&#x27;</span>, <span class="string">&#x27;root&#x27;</span>),  <span class="comment"># 数据库用户名，默认为root</span></span><br><span class="line">                <span class="string">&#x27;password&#x27;</span>: os.getenv(<span class="string">&#x27;BASE_PASSWORD&#x27;</span>, <span class="string">&#x27;ldx186729&#x27;</span>),  <span class="comment"># 数据库密码</span></span><br><span class="line">                <span class="string">&#x27;port&#x27;</span>: <span class="built_in">int</span>(os.getenv(<span class="string">&#x27;BASE_PORT&#x27;</span>, <span class="number">3306</span>)),  <span class="comment"># 数据库端口，默认为3306</span></span><br><span class="line">                <span class="string">&#x27;database&#x27;</span>: os.getenv(<span class="string">&#x27;BASE_DB&#x27;</span>, <span class="string">&#x27;base&#x27;</span>),  <span class="comment"># 数据库名称，默认为base</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment"># 其他数据库连接配置可以在这里添加，例如：</span></span><br><span class="line">        <span class="comment"># &quot;db2&quot;: &#123;</span></span><br><span class="line">        <span class="comment">#     &#x27;engine&#x27;: &#x27;tortoise.backends.mysql&#x27;,</span></span><br><span class="line">        <span class="comment">#     &quot;credentials&quot;: &#123;</span></span><br><span class="line">        <span class="comment">#         &#x27;host&#x27;: os.getenv(&#x27;DB2_HOST&#x27;, &#x27;127.0.0.1&#x27;),</span></span><br><span class="line">        <span class="comment">#         &#x27;user&#x27;: os.getenv(&#x27;DB2_USER&#x27;, &#x27;root&#x27;),</span></span><br><span class="line">        <span class="comment">#         &#x27;password&#x27;: os.getenv(&#x27;DB2_PASSWORD&#x27;, &#x27;123456&#x27;),</span></span><br><span class="line">        <span class="comment">#         &#x27;port&#x27;: int(os.getenv(&#x27;DB2_PORT&#x27;, 3306)),</span></span><br><span class="line">        <span class="comment">#         &#x27;database&#x27;: os.getenv(&#x27;DB2_DB&#x27;, &#x27;db2&#x27;),</span></span><br><span class="line">        <span class="comment">#     &#125;</span></span><br><span class="line">        <span class="comment"># &#125;,</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;apps&quot;</span>: &#123;</span><br><span class="line">        <span class="comment"># 应用配置</span></span><br><span class="line">        <span class="string">&quot;base&quot;</span>: &#123;<span class="string">&quot;models&quot;</span>: [<span class="string">&quot;models.base&quot;</span>], <span class="string">&quot;default_connection&quot;</span>: <span class="string">&quot;base&quot;</span>&#125;,  <span class="comment"># 使用models.base中的模型，默认连接为connections里的base</span></span><br><span class="line">        <span class="comment"># &quot;db2&quot;: &#123;&quot;models&quot;: [&quot;models.db2&quot;], &quot;default_connection&quot;: &quot;db2&quot;&#125;,</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;use_tz&#x27;</span>: <span class="literal">False</span>,  <span class="comment"># 是否使用时区，默认不使用</span></span><br><span class="line">    <span class="string">&#x27;timezone&#x27;</span>: <span class="string">&#x27;Asia/Shanghai&#x27;</span>  <span class="comment"># 时区设置为东八区</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 异步函数，用于注册MySQL数据库</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">link_db</span>(<span class="params">app: FastAPI</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 使用Tortoise ORM注册数据库</span></span><br><span class="line">        register_tortoise(</span><br><span class="line">            app,</span><br><span class="line">            config=DB_ORM_CONFIG,  <span class="comment"># 使用上面定义的数据库配置</span></span><br><span class="line">            generate_schemas=<span class="literal">False</span>,  <span class="comment"># 是否自动生成数据库表结构，默认不生成</span></span><br><span class="line">            add_exception_handlers=<span class="literal">True</span>,  <span class="comment"># 是否添加异常处理器，默认添加</span></span><br><span class="line">        )</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;数据库连接成功&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;数据库连接失败&quot;</span>, e)</span><br><span class="line">        <span class="keyword">raise</span> e</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">close_db</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 关闭所有数据库连接</span></span><br><span class="line">        <span class="keyword">await</span> Tortoise.close_connections()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;数据库关闭成功&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;数据库关闭失败&quot;</span>, e)</span><br><span class="line">        <span class="keyword">raise</span> e</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"># 使用Tortoise ORM注册数据库</span></span><br><span class="line">register_tortoise(</span><br><span class="line">    app,</span><br><span class="line">    config=DB_ORM_CONFIG,  <span class="comment"># 使用上面定义的数据库配置</span></span><br><span class="line">    generate_schemas=<span class="literal">False</span>,  <span class="comment"># 是否自动生成数据库表结构，默认不生成</span></span><br><span class="line">    add_exception_handlers=<span class="literal">True</span>,  <span class="comment"># 是否添加异常处理器，默认添加</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li>注意这里的<code>generate_schemas=False</code> 用于控制是否自动生成数据库表结构，默认不生成</li>
</ul>
<h3 id="1-2-定义ORM模型类用于与数据库交互"><a href="#1-2-定义ORM模型类用于与数据库交互" class="headerlink" title="1.2 定义ORM模型类用于与数据库交互"></a>1.2 定义ORM模型类用于与数据库交互</h3><ul>
<li>在<code>models/base.py</code>文件里</li>
<li>通过这些类可以对数据库进行增删改查</li>
<li>数据库交互相关操作见<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg2MjUxNDExOA==&action=getalbum&album_id=2996461450850467846#wechat_redirect">#Tortoise ORM</a></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tortoise <span class="keyword">import</span> fields</span><br><span class="line"><span class="keyword">from</span> tortoise.models <span class="keyword">import</span> Model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TimestampMixin</span>(<span class="title class_ inherited__">Model</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;时间戳抽象模型&quot;&quot;&quot;</span></span><br><span class="line">    create_time = fields.DatetimeField(auto_now_add=<span class="literal">True</span>, description=<span class="string">&#x27;创建时间&#x27;</span>)</span><br><span class="line">    update_time = fields.DatetimeField(auto_now=<span class="literal">True</span>, description=<span class="string">&quot;更新时间&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        abstract = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">TimestampMixin</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;用户表&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 多对多关系配置</span></span><br><span class="line">    roles: fields.ManyToManyRelation[<span class="string">&quot;Role&quot;</span>] = fields.ManyToManyField(</span><br><span class="line">        <span class="string">&quot;base.Role&quot;</span>,</span><br><span class="line">        related_name=<span class="string">&quot;users&quot;</span>,</span><br><span class="line">        through=<span class="string">&quot;user_role&quot;</span>,</span><br><span class="line">        description=<span class="string">&quot;关联角色&quot;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 基础信息</span></span><br><span class="line">    username = fields.CharField(unique=<span class="literal">True</span>, max_length=<span class="number">20</span>, description=<span class="string">&quot;登录账号&quot;</span>)</span><br><span class="line">    password = fields.CharField(max_length=<span class="number">255</span>, description=<span class="string">&quot;加密后的密码&quot;</span>)</span><br><span class="line">    nickname = fields.CharField(default=<span class="string">&#x27;&#x27;</span>, max_length=<span class="number">255</span>, description=<span class="string">&#x27;显示名称&#x27;</span>)</span><br><span class="line">    user_status = fields.SmallIntField(</span><br><span class="line">        default=<span class="number">1</span>,</span><br><span class="line">        description=<span class="string">&quot;状态：0=未激活 1=正常 2=禁用 3=锁定&quot;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 联系信息</span></span><br><span class="line">    user_phone = fields.CharField(</span><br><span class="line">        unique=<span class="literal">True</span>,</span><br><span class="line">        max_length=<span class="number">20</span>,</span><br><span class="line">        null=<span class="literal">True</span>,</span><br><span class="line">        description=<span class="string">&quot;手机号（带国际区号）&quot;</span></span><br><span class="line">    )</span><br><span class="line">    user_email = fields.CharField(</span><br><span class="line">        unique=<span class="literal">True</span>,</span><br><span class="line">        max_length=<span class="number">255</span>,</span><br><span class="line">        null=<span class="literal">True</span>,</span><br><span class="line">        description=<span class="string">&#x27;邮箱地址&#x27;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 附加信息</span></span><br><span class="line">    full_name = fields.CharField(null=<span class="literal">True</span>, max_length=<span class="number">255</span>, description=<span class="string">&#x27;真实姓名&#x27;</span>)</span><br><span class="line">    header_img = fields.CharField(null=<span class="literal">True</span>, max_length=<span class="number">512</span>, description=<span class="string">&#x27;头像URL&#x27;</span>)</span><br><span class="line">    sex = fields.SmallIntField(</span><br><span class="line">        default=<span class="number">0</span>,</span><br><span class="line">        description=<span class="string">&quot;性别：0=未知 1=男 2=女 3=其他&quot;</span></span><br><span class="line">    )</span><br><span class="line">    last_login = fields.DatetimeField(null=<span class="literal">True</span>, description=<span class="string">&quot;最后登录时间&quot;</span>)</span><br><span class="line">    last_ip = fields.CharField(null=<span class="literal">True</span>, max_length=<span class="number">45</span>, description=<span class="string">&quot;最后登录IP&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 审计日志</span></span><br><span class="line">    logs: fields.ReverseRelation[<span class="string">&quot;Log&quot;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        table = <span class="string">&quot;sys_user&quot;</span></span><br><span class="line">        table_description = <span class="string">&quot;系统用户表&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Role</span>(<span class="title class_ inherited__">TimestampMixin</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;角色表&quot;&quot;&quot;</span></span><br><span class="line">    users: fields.ManyToManyRelation[User]</span><br><span class="line">    accesses: fields.ManyToManyRelation[<span class="string">&quot;Access&quot;</span>] = fields.ManyToManyField(</span><br><span class="line">        <span class="string">&quot;base.Access&quot;</span>,</span><br><span class="line">        related_name=<span class="string">&quot;roles&quot;</span>,</span><br><span class="line">        through=<span class="string">&quot;role_access&quot;</span>,</span><br><span class="line">        description=<span class="string">&quot;关联权限&quot;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    role_key = fields.CharField(</span><br><span class="line">        unique=<span class="literal">True</span>,</span><br><span class="line">        max_length=<span class="number">15</span>,</span><br><span class="line">        description=<span class="string">&quot;角色标识（英文）&quot;</span></span><br><span class="line">    )</span><br><span class="line">    role_name = fields.CharField(</span><br><span class="line">        max_length=<span class="number">30</span>,</span><br><span class="line">        description=<span class="string">&quot;显示名称&quot;</span></span><br><span class="line">    )</span><br><span class="line">    role_status = fields.BooleanField(</span><br><span class="line">        default=<span class="literal">True</span>,</span><br><span class="line">        description=<span class="string">&quot;状态：True=启用 False=禁用&quot;</span></span><br><span class="line">    )</span><br><span class="line">    role_desc = fields.TextField(null=<span class="literal">True</span>, description=<span class="string">&#x27;角色描述&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        table = <span class="string">&quot;sys_role&quot;</span></span><br><span class="line">        table_description = <span class="string">&quot;系统角色表&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Access</span>(<span class="title class_ inherited__">TimestampMixin</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;权限表（支持三级结构）&quot;&quot;&quot;</span></span><br><span class="line">    roles: fields.ManyToManyRelation[Role]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 层级控制</span></span><br><span class="line">    parent: fields.ForeignKeyNullableRelation[<span class="string">&quot;Access&quot;</span>] = fields.ForeignKeyField(</span><br><span class="line">        <span class="string">&quot;base.Access&quot;</span>,</span><br><span class="line">        related_name=<span class="string">&quot;children&quot;</span>,</span><br><span class="line">        null=<span class="literal">True</span>,</span><br><span class="line">        description=<span class="string">&quot;父级权限&quot;</span></span><br><span class="line">    )</span><br><span class="line">    children: fields.ReverseRelation[<span class="string">&quot;Access&quot;</span>]</span><br><span class="line"></span><br><span class="line">    access_key = fields.CharField(</span><br><span class="line">        unique=<span class="literal">True</span>,</span><br><span class="line">        max_length=<span class="number">255</span>,</span><br><span class="line">        description=<span class="string">&quot;权限标识（格式：system:user:create）&quot;</span></span><br><span class="line">    )</span><br><span class="line">    access_name = fields.CharField(max_length=<span class="number">30</span>, description=<span class="string">&quot;权限名称&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 菜单相关</span></span><br><span class="line">    is_menu = fields.BooleanField(default=<span class="literal">False</span>, description=<span class="string">&#x27;是否为菜单 True菜单 False不是菜单&#x27;</span>)</span><br><span class="line">    route_path = fields.CharField(</span><br><span class="line">        null=<span class="literal">True</span>,</span><br><span class="line">        max_length=<span class="number">255</span>,</span><br><span class="line">        description=<span class="string">&quot;前端路由路径&quot;</span></span><br><span class="line">    )</span><br><span class="line">    component_path = fields.CharField(</span><br><span class="line">        null=<span class="literal">True</span>,</span><br><span class="line">        max_length=<span class="number">255</span>,</span><br><span class="line">        description=<span class="string">&quot;前端组件路径&quot;</span></span><br><span class="line">    )</span><br><span class="line">    menu_icon = fields.CharField(</span><br><span class="line">        null=<span class="literal">True</span>,</span><br><span class="line">        max_length=<span class="number">50</span>,</span><br><span class="line">        description=<span class="string">&quot;菜单图标（element-plus图标名）&quot;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 排序控制</span></span><br><span class="line">    sort_order = fields.IntField(</span><br><span class="line">        default=<span class="number">99</span>,</span><br><span class="line">        description=<span class="string">&quot;显示排序（同级有效）&quot;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        table = <span class="string">&quot;sys_access&quot;</span></span><br><span class="line">        table_description = <span class="string">&quot;系统权限表&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Log</span>(<span class="title class_ inherited__">TimestampMixin</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;访问日志表&quot;&quot;&quot;</span></span><br><span class="line">    user: fields.ForeignKeyRelation[User] = fields.ForeignKeyField(</span><br><span class="line">        <span class="string">&quot;base.User&quot;</span>,</span><br><span class="line">        related_name=<span class="string">&quot;logs&quot;</span>,</span><br><span class="line">        description=<span class="string">&quot;关联用户&quot;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 请求信息</span></span><br><span class="line">    request_method = fields.CharField(max_length=<span class="number">10</span>, description=<span class="string">&quot;HTTP方法&quot;</span>)</span><br><span class="line">    target_url = fields.CharField(max_length=<span class="number">1024</span>, description=<span class="string">&quot;请求URL&quot;</span>)</span><br><span class="line">    user_agent = fields.TextField(null=<span class="literal">True</span>, description=<span class="string">&quot;User-Agent&quot;</span>)</span><br><span class="line">    request_params = fields.JSONField(null=<span class="literal">True</span>, description=<span class="string">&quot;请求参数&quot;</span>)</span><br><span class="line">    client_ip = fields.CharField(max_length=<span class="number">45</span>, description=<span class="string">&quot;客户端IP&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 响应信息</span></span><br><span class="line">    response_code = fields.SmallIntField(description=<span class="string">&quot;HTTP响应码&quot;</span>)</span><br><span class="line">    process_time = fields.FloatField(description=<span class="string">&quot;处理耗时（毫秒）&quot;</span>)</span><br><span class="line">    error_info = fields.TextField(null=<span class="literal">True</span>, description=<span class="string">&quot;错误信息&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        table = <span class="string">&quot;sys_log&quot;</span></span><br><span class="line">        table_description = <span class="string">&quot;系统访问日志表&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="1-3-定义Pydantic模型类用于数据校验"><a href="#1-3-定义Pydantic模型类用于数据校验" class="headerlink" title="1.3 定义Pydantic模型类用于数据校验"></a>1.3 定义Pydantic模型类用于数据校验</h3><ul>
<li>在<code>schems</code>文件夹下</li>
<li>主要用户请求数据和响应数据时的数据校验</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, Field</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------- 登录认证相关 ----------</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AccountLogin</span>(<span class="title class_ inherited__">BaseModel</span>):  </span><br><span class="line">    username: <span class="built_in">str</span> = Field(..., example=<span class="string">&quot;admin&quot;</span>)  </span><br><span class="line">    password: <span class="built_in">str</span> = Field(..., example=<span class="string">&quot;123456&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>相关路由</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@router.post(<span class="params"><span class="string">&quot;/account/login&quot;</span>, response_model=user.UserLogin, summary=<span class="string">&quot;用户登陆&quot;</span></span>)  </span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">account_login</span>(<span class="params">post: user.AccountLogin</span>):</span><br><span class="line">	<span class="comment"># 1. 查询用户  </span></span><br><span class="line">	get_user = <span class="keyword">await</span> User.get_or_none(username=post.username)</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">not</span> get_user:  </span><br><span class="line">    	<span class="keyword">return</span> fail(msg=<span class="string">&quot;用户名或密码错误&quot;</span>)  <span class="comment"># 模糊提示更安全</span></span><br></pre></td></tr></table></figure>

<h2 id="2-Redis-配置"><a href="#2-Redis-配置" class="headerlink" title="2 Redis 配置"></a>2 Redis 配置</h2><h3 id="2-1-安装与配置"><a href="#2-1-安装与配置" class="headerlink" title="2.1 安装与配置"></a>2.1 安装与配置</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44893902/article/details/123087435">Window下Redis的安装和部署详细图文教程（Redis的安装和可视化工具的使用）_redis安装-CSDN博客</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> aioredis</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> aioredis <span class="keyword">import</span> Redis, ConnectionPool</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">link_redis</span>(<span class="params">app: FastAPI</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    系统缓存</span></span><br><span class="line"><span class="string">    :return: cache 连接池</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 创建连接池</span></span><br><span class="line">        app.state.redis_pool = ConnectionPool.from_url(</span><br><span class="line">            <span class="string">f&quot;redis://<span class="subst">&#123;os.getenv(<span class="string">&#x27;CACHE_HOST&#x27;</span>, <span class="string">&#x27;127.0.0.1&#x27;</span>)&#125;</span>:<span class="subst">&#123;os.getenv(<span class="string">&#x27;CACHE_PORT&#x27;</span>, <span class="number">6379</span>)&#125;</span>&quot;</span>,</span><br><span class="line">            db=os.getenv(<span class="string">&#x27;CACHE_DB&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">            encoding=<span class="string">&#x27;utf-8&#x27;</span>,</span><br><span class="line">            decode_responses=<span class="literal">True</span></span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># 创建全局 Redis 实例</span></span><br><span class="line">        app.state.redis = Redis(connection_pool=app.state.redis_pool)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;redis连接成功&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;redis连接失败&quot;</span>, e)</span><br><span class="line">        <span class="keyword">raise</span> e</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">close_redis</span>(<span class="params">app: FastAPI</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">await</span> app.state.redis.close()  <span class="comment"># 关闭客户端</span></span><br><span class="line">        <span class="keyword">await</span> app.state.redis_pool.disconnect()  <span class="comment"># 断开所有连接</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;redis关闭成功&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;redis关闭失败&quot;</span>, e)</span><br><span class="line">        <span class="keyword">raise</span> e</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-2-基本使用"><a href="#2-2-基本使用" class="headerlink" title="2.2 基本使用"></a>2.2 基本使用</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> core.Response <span class="keyword">import</span> success  <span class="comment"># 导入success函数，用于返回成功的响应  </span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Depends, Request  <span class="comment"># 导入FastAPI的Depends和Request类  </span></span><br><span class="line"><span class="keyword">from</span> database.redis <span class="keyword">import</span> sys_cache  <span class="comment"># 导入sys_cache依赖，用于获取Redis连接  </span></span><br><span class="line"><span class="keyword">from</span> aioredis <span class="keyword">import</span> Redis  <span class="comment"># 导入aioredis的Redis类，用于异步操作Redis  </span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">test_my_redis</span>(<span class="params">req: Request</span>):  </span><br><span class="line">    <span class="string">&quot;&quot;&quot;  </span></span><br><span class="line"><span class="string">    测试从请求对象中获取Redis缓存的值  </span></span><br><span class="line"><span class="string">    :param req: FastAPI的Request对象，包含应用程序状态  </span></span><br><span class="line"><span class="string">    :return: 成功响应，包含从Redis获取的值  </span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>    <span class="comment"># 从请求对象的应用程序状态中获取Redis缓存池，并获取键为&quot;today&quot;的值  </span></span><br><span class="line">    value = <span class="keyword">await</span> req.app.state.cache.get(<span class="string">&quot;ex_today&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">    <span class="comment"># 返回成功的响应，消息为&quot;test_my_redis&quot;，数据为从Redis获取的值  </span></span><br><span class="line">    <span class="keyword">return</span> success(msg=<span class="string">&quot;test_my_redis&quot;</span>, data=[value])  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">test_my_redis_depends</span>(<span class="params">today: <span class="built_in">int</span>, cache: Redis = Depends(<span class="params">sys_cache</span>)</span>):  </span><br><span class="line">    <span class="string">&quot;&quot;&quot;  </span></span><br><span class="line"><span class="string">    测试使用依赖注入获取Redis连接，并设置和获取缓存值  </span></span><br><span class="line"><span class="string">    :param today: 今天是几号，整数类型  </span></span><br><span class="line"><span class="string">    :param cache: 通过依赖注入获取的Redis连接  </span></span><br><span class="line"><span class="string">    :return: 成功响应，包含今天是几号的消息  </span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>    <span class="comment"># 设置键为&quot;ex_today&quot;的值为today，并设置过期时间为60秒  </span></span><br><span class="line">    <span class="keyword">await</span> cache.<span class="built_in">set</span>(name=<span class="string">&quot;ex_today&quot;</span>, value=today, ex=<span class="number">60</span>)  </span><br><span class="line">  </span><br><span class="line">    <span class="comment"># 从Redis中获取键为&quot;ex_today&quot;的值  </span></span><br><span class="line">    value = <span class="keyword">await</span> cache.get(<span class="string">&quot;ex_today&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">    <span class="comment"># 打印从Redis获取的值  </span></span><br><span class="line">    <span class="built_in">print</span>(value)  </span><br><span class="line">  </span><br><span class="line">    <span class="comment"># 返回成功的响应，消息为&quot;今天是&#123;today&#125;号&quot;，数据为空列表  </span></span><br><span class="line">    <span class="keyword">return</span> success(msg=<span class="string">f&quot;今天是<span class="subst">&#123;today&#125;</span>号&quot;</span>, data=[])</span><br></pre></td></tr></table></figure>

<h2 id="3-Minio-配置"><a href="#3-Minio-配置" class="headerlink" title="3 Minio 配置"></a>3 Minio 配置</h2><blockquote>
<p>Minio是一个基于Apache License v2.0开源协议的对象存储服务。它可以看作是我们自己搭建的迷你版亚马逊S3，可以存储图片、视频、日志文件等任何类型的数据。它的Python SDK使用起来特别简单，让我们看看怎么用吧！</p>
</blockquote>
<h3 id="3-1-安装MinIO"><a href="#3-1-安装MinIO" class="headerlink" title="3.1 安装MinIO"></a>3.1 安装MinIO</h3><p><a target="_blank" rel="noopener" href="https://www.minio.org.cn/docs/minio/windows/index.html">MinIO对象存储 Windows — MinIO中文文档 | MinIO Windows中文文档</a></p>
<p>下载 MinIO 服务器的地址如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://dl.minio.org.cn/server/minio/release/windows-amd64/minio.exe</span><br></pre></td></tr></table></figure>

<p>放在 <code>C:\ENV\minio</code>，然后配置环境变量</p>
<p>然后在 CMD 中输入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">minio.exe server C:\ENV\minio --console-address :9090</span><br></pre></td></tr></table></figure>

<p>这里<code>C:\ENV\minio</code>配置存储数据的地址的</p>
<p><img src="https://picgocloud.oss-cn-shanghai.aliyuncs.com/picgo/20250313204449.png" alt="image.png"></p>
<p><img src="https://picgocloud.oss-cn-shanghai.aliyuncs.com/picgo/20250313204457.png" alt="image.png|685"></p>
<p>打印结果如下</p>
<p><img src="https://picgocloud.oss-cn-shanghai.aliyuncs.com/picgo/20250313204641.png" alt="image.png"></p>
<p>打开 <a target="_blank" rel="noopener" href="http://localhost:9090/">http://localhost:9090</a> ，然后输入账号密码即可</p>
<p><img src="https://picgocloud.oss-cn-shanghai.aliyuncs.com/picgo/20250313204933.png" alt="image.png"></p>
<p>直接创建一个桶</p>
<p><img src="https://picgocloud.oss-cn-shanghai.aliyuncs.com/picgo/20250313210620.png" alt="image.png"></p>
<p>然后设置文件公开访问，默认创建的存储桶，均为私有桶，无法被公开访问。</p>
<p><img src="https://picgocloud.oss-cn-shanghai.aliyuncs.com/picgo/20250313210737.png" alt="image.png|753"></p>
<p><img src="https://picgocloud.oss-cn-shanghai.aliyuncs.com/picgo/20250313210805.png" alt="image.png|806"></p>
<p>这样就能通过 <a target="_blank" rel="noopener" href="http://localhost:9000/fastapi/unnamed.jpg">http://localhost:9000/fastapi/unnamed.jpg</a> 访问到了</p>
<h3 id="3-2-基础配置"><a href="#3-2-基础配置" class="headerlink" title="3.2 基础配置"></a>3.2 基础配置</h3><p>创建访问密钥</p>
<p><img src="https://picgocloud.oss-cn-shanghai.aliyuncs.com/picgo/20250313211250.png" alt="image.png"></p>
<p><img src="https://picgocloud.oss-cn-shanghai.aliyuncs.com/picgo/20250313211320.png" alt="image.png"></p>
<p>安装 MinIO</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install minio </span><br></pre></td></tr></table></figure>

<p>配置端口和密钥</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> minio <span class="keyword">import</span> Minio  </span><br><span class="line"><span class="keyword">from</span> minio.error <span class="keyword">import</span> S3Error  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">try</span>:  </span><br><span class="line">    <span class="comment"># 创建Minio客户端  </span></span><br><span class="line">    minio_client = Minio(  </span><br><span class="line">        <span class="string">&quot;localhost:9000&quot;</span>,  <span class="comment"># Minio服务器地址  </span></span><br><span class="line">        access_key=<span class="string">&quot;5N5p56FKOWD4ID06mMFS&quot;</span>,  </span><br><span class="line">        secret_key=<span class="string">&quot;XTvkrYQQ7lGicq4SXIAP2jz8JKqMVtVUbMZr6QSf&quot;</span>,  </span><br><span class="line">        secure=<span class="literal">False</span>  <span class="comment"># 使用HTTPS  </span></span><br><span class="line">    )  </span><br><span class="line">    bucket_name = <span class="string">&quot;fastapi&quot;</span> <span class="comment"># 存储桶名称  </span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> minio_client.bucket_exists(bucket_name):  </span><br><span class="line">        minio_client.make_bucket(bucket_name)  </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;存储桶 <span class="subst">&#123;bucket_name&#125;</span> 创建成功&quot;</span>)  </span><br><span class="line">    <span class="keyword">else</span>:  </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;存储桶 <span class="subst">&#123;bucket_name&#125;</span> 已存在&quot;</span>)  </span><br><span class="line"><span class="keyword">except</span> S3Error <span class="keyword">as</span> err:  </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;发生错误：<span class="subst">&#123;err&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="3-3-基本操作"><a href="#3-3-基本操作" class="headerlink" title="3.3 基本操作"></a>3.3 基本操作</h3><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=Mzk2NDY2NDM2MA==&mid=2247483749&idx=1&sn=fdee744fb9095d5d7f63923de3a5d117&chksm=c59831198046aaa19638828a58232a2537c7c943b19a8c95551f9436780fce5dc5eebfd704ff#rd">minio基础使用</a></p>
<h4 id="3-3-1-存储桶操作"><a href="#3-3-1-存储桶操作" class="headerlink" title="3.3.1 存储桶操作"></a>3.3.1 存储桶操作</h4><p>存储桶（Bucket）就像是文件系统中的文件夹，用来组织和管理对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> minio <span class="keyword">import</span> Minio  </span><br><span class="line"><span class="keyword">from</span> minio.error <span class="keyword">import</span> S3Error  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">manage_bucket</span>():  </span><br><span class="line">    <span class="comment"># 初始化客户端  </span></span><br><span class="line">    client = Minio(  </span><br><span class="line">        <span class="string">&quot;localhost:9000&quot;</span>,  </span><br><span class="line">        access_key=<span class="string">&quot;minioadmin&quot;</span>,  </span><br><span class="line">        secret_key=<span class="string">&quot;minioadmin&quot;</span>,  </span><br><span class="line">        secure=<span class="literal">False</span>  </span><br><span class="line">    )  </span><br><span class="line">      </span><br><span class="line">    <span class="comment"># 创建新的存储桶  </span></span><br><span class="line">    bucket_name = <span class="string">&quot;photos&quot;</span>  </span><br><span class="line">    <span class="keyword">try</span>:  </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> client.bucket_exists(bucket_name):  </span><br><span class="line">            client.make_bucket(bucket_name)  </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;存储桶 <span class="subst">&#123;bucket_name&#125;</span> 创建成功&quot;</span>)  </span><br><span class="line">        <span class="keyword">else</span>:  </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;存储桶 <span class="subst">&#123;bucket_name&#125;</span> 已存在&quot;</span>)  </span><br><span class="line">    <span class="keyword">except</span> S3Error <span class="keyword">as</span> err:  </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;发生错误：<span class="subst">&#123;err&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="3-3-2-上传文件"><a href="#3-3-2-上传文件" class="headerlink" title="3.3.2 上传文件"></a>3.3.2 上传文件</h4><p>Minio提供了多种上传文件的方式：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方式1：上传本地文件  </span></span><br><span class="line">client.fput_object(<span class="string">&quot;mybucket&quot;</span>, <span class="string">&quot;photo.jpg&quot;</span>, <span class="string">&quot;/path/to/photo.jpg&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># 方式2：上传字节数据  </span></span><br><span class="line">data = <span class="string">b&quot;Hello, Minio!&quot;</span>  </span><br><span class="line">client.put_object(<span class="string">&quot;mybucket&quot;</span>, <span class="string">&quot;hello.txt&quot;</span>, data, length=<span class="built_in">len</span>(data))  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># 方式3：上传大文件（分片上传）  </span></span><br><span class="line">client.fput_object(  </span><br><span class="line">    <span class="string">&quot;mybucket&quot;</span>, <span class="string">&quot;bigfile.zip&quot;</span>, <span class="string">&quot;/path/to/bigfile.zip&quot;</span>,  </span><br><span class="line">    metadata=&#123;<span class="string">&quot;description&quot;</span>: <span class="string">&quot;我的大文件&quot;</span>&#125;  </span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>小贴士：上传大文件时，Minio会自动使用分片上传，不用我们操心！</p>
</blockquote>
<h4 id="3-3-3-下载文件"><a href="#3-3-3-下载文件" class="headerlink" title="3.3.3 下载文件"></a>3.3.3 下载文件</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">download_files</span>():  </span><br><span class="line">    <span class="keyword">try</span>:  </span><br><span class="line">        <span class="comment"># 下载到本地文件  </span></span><br><span class="line">        client.fget_object(  </span><br><span class="line">            <span class="string">&quot;mybucket&quot;</span>, <span class="string">&quot;photo.jpg&quot;</span>, <span class="string">&quot;/local/path/photo.jpg&quot;</span>  </span><br><span class="line">        )  </span><br><span class="line">          </span><br><span class="line">        <span class="comment"># 获取文件数据  </span></span><br><span class="line">        data = client.get_object(<span class="string">&quot;mybucket&quot;</span>, <span class="string">&quot;hello.txt&quot;</span>).read()  </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;文件内容：<span class="subst">&#123;data.decode()&#125;</span>&quot;</span>)  </span><br><span class="line">          </span><br><span class="line">    <span class="keyword">except</span> S3Error <span class="keyword">as</span> err:  </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;下载失败：<span class="subst">&#123;err&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="3-4-上传图片案例"><a href="#3-4-上传图片案例" class="headerlink" title="3.4 上传图片案例"></a>3.4 上传图片案例</h3><p>后端</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">BASE_URL = <span class="string">&quot;http://localhost:9000&quot;</span>  </span><br><span class="line">BUCKETNAME = <span class="string">&quot;fastapi&quot;</span>  </span><br><span class="line"><span class="meta">@router.put(<span class="params"><span class="string">&quot;/uploadPhoto&quot;</span>,  </span></span></span><br><span class="line"><span class="params"><span class="meta">            summary=<span class="string">&quot;用户上传头像&quot;</span>,  </span></span></span><br><span class="line"><span class="params"><span class="meta">            dependencies=[Security(<span class="params">check_permissions, scopes=[<span class="string">&quot;user_upload_photo&quot;</span>]</span>)]</span>)  </span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">upload_photo</span>(<span class="params">file: UploadFile</span>):  </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;file&quot;</span>, file)  </span><br><span class="line">    <span class="comment"># 生成唯一文件名  </span></span><br><span class="line">    file_name = <span class="string">f&quot;<span class="subst">&#123;uuid.uuid4()&#125;</span><span class="subst">&#123;file.filename&#125;</span>&quot;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="comment"># 将bytes转换为文件流  </span></span><br><span class="line">    content = <span class="keyword">await</span> file.read()  </span><br><span class="line">    data_stream = BytesIO(content)  </span><br><span class="line">  </span><br><span class="line">    <span class="comment"># 上传到Minio  </span></span><br><span class="line">    minio_client.put_object(  </span><br><span class="line">        BUCKETNAME,  <span class="comment"># 存储桶名称  </span></span><br><span class="line">        file_name,  <span class="comment"># 对象名称  </span></span><br><span class="line">        data_stream,  <span class="comment"># 必须为流式数据  </span></span><br><span class="line">        length=<span class="built_in">len</span>(content),  </span><br><span class="line">        content_type=file.content_type  </span><br><span class="line">    )  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> success(data=&#123;<span class="string">&quot;url&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;BASE_URL&#125;</span>/<span class="subst">&#123;BUCKETNAME&#125;</span>/<span class="subst">&#123;file_name&#125;</span>&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>前端</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">uploadPhoto</span>(<span class="params">data: FormData</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> hyRequest.<span class="property">put</span>&lt;<span class="title class_">IDataType</span>&lt;&#123; <span class="attr">url</span>: string &#125;&gt;&gt;(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="title class_">UserAPI</span>.<span class="property">UploadPhoto</span>,</span><br><span class="line">    <span class="attr">data</span>: data,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">uploadHeaderImage</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (fileList.<span class="property">value</span>.<span class="property">length</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> formData = <span class="keyword">new</span> <span class="title class_">FormData</span>()</span><br><span class="line">    formData.<span class="title function_">append</span>(<span class="string">&#x27;file&#x27;</span>, fileList.<span class="property">value</span>[<span class="number">0</span>].<span class="property">raw</span>!) <span class="comment">// 后端要求字段名为 &quot;file&quot;</span></span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">uploadPhoto</span>(formData) <span class="comment">// 传递 FormData</span></span><br><span class="line">    <span class="keyword">if</span> (res &amp;&amp; res.<span class="property">code</span> == <span class="number">200</span>) &#123;</span><br><span class="line">      fileList.<span class="property">value</span> = []</span><br><span class="line">      <span class="keyword">return</span> res.<span class="property">data</span>.<span class="property">url</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://VernalScenery.github.io">Scenery</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://vernalscenery.github.io/2025/03/14/%E5%90%8E%E7%AB%AF/FastApi/01_FastApi_%E9%A1%B9%E7%9B%AE%E6%90%AD%E5%BB%BA%E4%B8%8E%E5%AD%A6%E4%B9%A0/">https://vernalscenery.github.io/2025/03/14/%E5%90%8E%E7%AB%AF/FastApi/01_FastApi_%E9%A1%B9%E7%9B%AE%E6%90%AD%E5%BB%BA%E4%B8%8E%E5%AD%A6%E4%B9%A0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://VernalScenery.github.io" target="_blank">春和景明的记事本</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/FastApi/">FastApi</a></div><div class="post_share"><div class="social-share" data-image="/./img/1.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/03/17/Python%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/00_Python%E5%9F%8E%E5%B8%82%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90_%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/" title="00_Python城市数据分析_环境配置"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">00_Python城市数据分析_环境配置</div></div></a></div><div class="next-post pull-right"><a href="/2025/01/03/%E5%9B%BE%E5%BD%A2%E5%AD%A6/WebGL/05_WeBGL_%E4%B8%89%E7%BB%B4%E5%9C%BA%E6%99%AF%E5%9F%BA%E7%A1%80/" title="05_WeBGL_三维场景基础"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">05_WeBGL_三维场景基础</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/./img/1.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Scenery</div><div class="author-info__description">今天不想跑，所以才去跑</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">73</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/chjm0121" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="/1595718686@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E5%9F%BA%E7%A1%80%E6%9E%84%E5%BB%BA"><span class="toc-text">项目基础构建</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E4%BE%9D%E8%B5%96%E9%A1%B9"><span class="toc-text">1 依赖项</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-text">2 常用命令</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="toc-text">基础概念</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%AE%98%E7%BD%91%E4%BB%8B%E7%BB%8D"><span class="toc-text">1 官网介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-ASGI-%E5%92%8C-Uvicorn"><span class="toc-text">2 ASGI 和 Uvicorn</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Starlette"><span class="toc-text">3 Starlette</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-Starlette-%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD%E4%B8%8E%E5%AE%9A%E4%BD%8D"><span class="toc-text">3.1 Starlette 核心功能与定位</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-Starlette-%E5%9C%A8-FastAPI-%E4%B8%AD%E7%9A%84%E6%A0%B8%E5%BF%83%E4%BD%9C%E7%94%A8"><span class="toc-text">3.2 Starlette 在 FastAPI 中的核心作用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Pydantic"><span class="toc-text">4 Pydantic</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E7%AE%80%E4%BB%8B"><span class="toc-text">4.1 简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-Pydantic-%E5%9F%BA%E7%A1%80%E6%A8%A1%E5%9E%8B"><span class="toc-text">4.2 Pydantic 基础模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E6%A0%A1%E9%AA%8C%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-text">4.3 校验异常处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E7%BB%A7%E6%89%BF%E6%A8%A1%E5%9E%8B%E6%96%B9%E6%B3%95%E4%B8%8E%E5%B1%9E%E6%80%A7"><span class="toc-text">4.4 继承模型方法与属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-%E9%80%92%E5%BD%92%E6%A8%A1%E5%9E%8B%E5%B5%8C%E5%A5%97"><span class="toc-text">4.5 递归模型嵌套</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-ORM-%E6%A8%A1%E5%9E%8B%E9%9B%86%E6%88%90"><span class="toc-text">4.6 ORM 模型集成</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-6-1-%E4%BB%80%E4%B9%88%E6%98%AF-ORM"><span class="toc-text">4.6.1 什么是 ORM</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-6-2-Pydantic-%E4%B8%8E-Tortoise-ORM-%E6%A8%A1%E5%9E%8B%E9%9B%86%E6%88%90"><span class="toc-text">4.6.2 Pydantic 与 Tortoise ORM 模型集成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-6-3-%E6%89%8B%E5%8A%A8%E7%94%9F%E6%88%90Pydantic%E6%A8%A1%E5%9E%8B"><span class="toc-text">4.6.3 手动生成Pydantic模型</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AD%97%E6%AE%B5%E6%98%BE%E5%BC%8F%E6%98%A0%E5%B0%84%EF%BC%88ORM-%E2%86%92-Pydantic%EF%BC%89"><span class="toc-text">字段显式映射（ORM → Pydantic）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%AA%8C%E8%AF%81%E9%80%BB%E8%BE%91"><span class="toc-text">自定义验证逻辑</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0%E5%92%8C%E9%AA%8C%E8%AF%81"><span class="toc-text">请求参数和验证</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E8%B7%AF%E7%94%B1%E7%AE%A1%E7%90%86"><span class="toc-text">1 路由管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%8F%82%E6%95%B0%E7%B1%BB%E5%9E%8B"><span class="toc-text">2 参数类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E8%B7%AF%E5%BE%84%E5%8F%82%E6%95%B0%EF%BC%88Path-Parameters%EF%BC%89"><span class="toc-text">2.1 路径参数（Path Parameters）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E6%9F%A5%E8%AF%A2%E5%8F%82%E6%95%B0"><span class="toc-text">2.2 查询参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E8%AF%B7%E6%B1%82%E4%BD%93%EF%BC%88Request-Body%EF%BC%89%E2%80%8B"><span class="toc-text">2.3 请求体（Request Body）​</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E6%B7%B7%E5%90%88%E5%8F%82%E6%95%B0"><span class="toc-text">2.4 混合参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-Cookie-%E5%92%8C-Header-%E5%8F%82%E6%95%B0"><span class="toc-text">2.5 Cookie 和 Header 参数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-1-%E5%A4%84%E7%90%86-Cookie-%E5%8F%82%E6%95%B0"><span class="toc-text">2.5.1 处理 Cookie 参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-2-%E5%A4%84%E7%90%86-Header-%E5%8F%82%E6%95%B0"><span class="toc-text">2.5.2 处理 Header 参数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E9%AA%8C%E8%AF%81%E8%A7%84%E5%88%99"><span class="toc-text">3 验证规则</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E2%80%8B1-Query%EF%BC%88%E6%9F%A5%E8%AF%A2%E5%8F%82%E6%95%B0%E9%AA%8C%E8%AF%81%EF%BC%89%E2%80%8B"><span class="toc-text">3.1 ​1. Query（查询参数验证）​</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-1-%E2%80%8B%E5%B8%B8%E7%94%A8%E9%AA%8C%E8%AF%81%E8%A7%84%E5%88%99%EF%BC%9A"><span class="toc-text">3.1.1 ​常用验证规则：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-2-%E2%80%8B%E7%A4%BA%E4%BE%8B%EF%BC%9A"><span class="toc-text">3.1.2 ​示例：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E2%80%8B2-Path%EF%BC%88%E8%B7%AF%E5%BE%84%E5%8F%82%E6%95%B0%E9%AA%8C%E8%AF%81%EF%BC%89"><span class="toc-text">3.2 ​2. Path（路径参数验证）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1-%E2%80%8B%E5%B8%B8%E7%94%A8%E9%AA%8C%E8%AF%81%E8%A7%84%E5%88%99%EF%BC%9A"><span class="toc-text">3.2.1 ​常用验证规则：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-2-%E2%80%8B%E7%A4%BA%E4%BE%8B%EF%BC%9A"><span class="toc-text">3.2.2 ​示例：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-3-Field%EF%BC%88Pydantic-%E6%A8%A1%E5%9E%8B%E5%AD%97%E6%AE%B5%E9%AA%8C%E8%AF%81%EF%BC%89"><span class="toc-text">3.3 3. Field（Pydantic 模型字段验证）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-1-%E2%80%8B%E5%B8%B8%E7%94%A8%E9%AA%8C%E8%AF%81%E8%A7%84%E5%88%99%EF%BC%9A"><span class="toc-text">3.3.1 ​常用验证规则：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-2-%E2%80%8B%E7%A4%BA%E4%BE%8B%EF%BC%9A"><span class="toc-text">3.3.2 ​示例：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E2%80%8B4-BaseModel%EF%BC%88%E7%BB%93%E6%9E%84%E5%8C%96%E6%95%B0%E6%8D%AE%E9%AA%8C%E8%AF%81%EF%BC%89"><span class="toc-text">3.4 ​4. BaseModel（结构化数据验证）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-1-%E2%80%8B%E9%AA%8C%E8%AF%81%E8%A7%84%E5%88%99-%EF%BC%9A"><span class="toc-text">3.4.1 ​验证规则*：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-2-%E2%80%8B%E7%A4%BA%E4%BE%8B%EF%BC%9A"><span class="toc-text">3.4.2 ​示例：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-%E2%80%8B%E6%80%BB%E7%BB%93%E5%AF%B9%E6%AF%94"><span class="toc-text">3.5 ​总结对比</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%93%8D%E5%BA%94%E5%A4%84%E7%90%86"><span class="toc-text">响应处理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%93%8D%E5%BA%94%E6%A8%A1%E5%9E%8B%EF%BC%88Response-Model%EF%BC%89"><span class="toc-text">1 响应模型（Response Model）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%93%8D%E5%BA%94%E7%8A%B6%E6%80%81%E7%A0%81%EF%BC%88Response-Status-Code%EF%BC%89"><span class="toc-text">2 响应状态码（Response Status Code）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E8%A1%A8%E5%8D%95%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%EF%BC%88Form-Data%EF%BC%89%E2%80%8B"><span class="toc-text">3 表单数据处理（Form Data）​</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%EF%BC%88File-Upload%EF%BC%89"><span class="toc-text">4 文件上传（File Upload）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E8%B7%AF%E5%BE%84%E6%93%8D%E4%BD%9C%E9%85%8D%E7%BD%AE%EF%BC%88Path-Operation-Configuration%EF%BC%89"><span class="toc-text">5 路径操作配置（Path Operation Configuration）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#FastAPI-%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE"><span class="toc-text">FastAPI 基础配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-FastAPI-%E5%BA%94%E7%94%A8%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE"><span class="toc-text">1 FastAPI 应用全局配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%8C%82%E8%BD%BD%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6"><span class="toc-text">2 挂载静态文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-text">3 自定义异常处理器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%A4%84%E7%90%86-HTTP-%E5%BC%82%E5%B8%B8"><span class="toc-text">3.1 处理 HTTP 异常</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E2%80%8B%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82%E9%AA%8C%E8%AF%81%E9%94%99%E8%AF%AF"><span class="toc-text">3.2 ​处理请求验证错误</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E2%80%8B%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-text">3.3 ​注意事项</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E4%BA%8B%E4%BB%B6"><span class="toc-text">4 生命周期事件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-text">5 环境变量</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#FastApi-%E7%9A%84-%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-text">FastApi 的 中间件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-text">1 中间件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E8%B7%A8%E5%9F%9F"><span class="toc-text">2 跨域</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E4%BB%80%E4%B9%88%E6%98%AF%E8%B7%A8%E5%9F%9F%EF%BC%9F"><span class="toc-text">2.1 什么是跨域？</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-1-%E2%80%8B%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5%E7%A4%BA%E4%BE%8B"><span class="toc-text">2.1.1 ​同源策略示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E8%B7%A8%E5%9F%9F%E9%99%90%E5%88%B6%EF%BC%9F"><span class="toc-text">2.2 为什么需要跨域限制？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E2%80%8B%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98%EF%BC%9F"><span class="toc-text">2.3 ​如何解决跨域问题？</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-1-%E2%80%8BCORS%EF%BC%88%E8%B7%A8%E5%9F%9F%E8%B5%84%E6%BA%90%E5%85%B1%E4%BA%AB%EF%BC%89"><span class="toc-text">2.3.1 ​CORS（跨域资源共享）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-2-%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-text">2.3.2 代理服务器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-CORS-%E6%A0%B8%E5%BF%83%E5%93%8D%E5%BA%94%E5%A4%B4"><span class="toc-text">2.4 CORS 核心响应头</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#FastApi-%E7%9A%84%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5%E7%B3%BB%E7%BB%9F"><span class="toc-text">FastApi 的依赖注入系统</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%9F%BA%E6%9C%AC%E4%BE%9D%E8%B5%96%E5%A3%B0%E6%98%8E%E4%B8%8E%E4%BD%BF%E7%94%A8"><span class="toc-text">1 基本依赖声明与使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E7%B1%BB%E4%BD%9C%E4%B8%BA%E4%BE%9D%E8%B5%96%E9%A1%B9"><span class="toc-text">2 类作为依赖项</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%AD%90%E4%BE%9D%E8%B5%96%EF%BC%88%E5%B5%8C%E5%A5%97%E4%BE%9D%E8%B5%96%EF%BC%89"><span class="toc-text">3 子依赖（嵌套依赖）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E8%B7%AF%E5%BE%84%E8%A3%85%E9%A5%B0%E5%99%A8%E4%B8%AD%E7%9A%84%E4%BE%9D%E8%B5%96"><span class="toc-text">4 路径装饰器中的依赖</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%85%A8%E5%B1%80%E4%BE%9D%E8%B5%96"><span class="toc-text">5 全局依赖</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E5%B8%A6%E8%B5%84%E6%BA%90%E7%9A%84%E4%BE%9D%E8%B5%96%EF%BC%88yield%EF%BC%89%E2%80%8B"><span class="toc-text">6 带资源的依赖（yield）​</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E3%80%81%E8%AE%A4%E8%AF%81%E5%92%8C%E6%8E%88%E6%9D%83"><span class="toc-text">安全、认证和授权</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-OAuth2-%E8%AE%A4%E8%AF%81"><span class="toc-text">1 OAuth2 认证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-OAuth2-%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F%EF%BC%88Password-Grant%EF%BC%89"><span class="toc-text">1.1 OAuth2 密码模式（Password Grant）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E2%80%8BFastAPI-%E7%9A%84-OAuth2PasswordBearer"><span class="toc-text">1.2 ​FastAPI 的 OAuth2PasswordBearer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E5%9F%BA%E4%BA%8E-Password-%E5%92%8C-Bearer-token-%E7%9A%84-OAuth2-%E8%AE%A4%E8%AF%81"><span class="toc-text">1.3 基于 Password 和 Bearer token 的 OAuth2 认证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-JWT-%E8%AE%A4%E8%AF%81"><span class="toc-text">2 JWT 认证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Security%E6%9D%83%E9%99%90%E9%AA%8C%E8%AF%81"><span class="toc-text">3 Security权限验证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-RBAC-%E6%9D%83%E9%99%90%E8%AE%BE%E8%AE%A1"><span class="toc-text">4 RBAC 权限设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-Session%E5%92%8C-Cookie"><span class="toc-text">5 Session和 Cookie</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MySQL%E3%80%81Redis%E3%80%81Minio-%E9%85%8D%E7%BD%AE"><span class="toc-text">MySQL、Redis、Minio 配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-MySQL-%E9%85%8D%E7%BD%AE"><span class="toc-text">1 MySQL 配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E6%A0%B9%E6%8D%AE%E9%85%8D%E7%BD%AE%E7%94%9F%E6%88%90%E5%AE%9E%E4%BE%8B"><span class="toc-text">1.1 根据配置生成实例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E5%AE%9A%E4%B9%89ORM%E6%A8%A1%E5%9E%8B%E7%B1%BB%E7%94%A8%E4%BA%8E%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%A4%E4%BA%92"><span class="toc-text">1.2 定义ORM模型类用于与数据库交互</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E5%AE%9A%E4%B9%89Pydantic%E6%A8%A1%E5%9E%8B%E7%B1%BB%E7%94%A8%E4%BA%8E%E6%95%B0%E6%8D%AE%E6%A0%A1%E9%AA%8C"><span class="toc-text">1.3 定义Pydantic模型类用于数据校验</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Redis-%E9%85%8D%E7%BD%AE"><span class="toc-text">2 Redis 配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE"><span class="toc-text">2.1 安装与配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-text">2.2 基本使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Minio-%E9%85%8D%E7%BD%AE"><span class="toc-text">3 Minio 配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%AE%89%E8%A3%85MinIO"><span class="toc-text">3.1 安装MinIO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE"><span class="toc-text">3.2 基础配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="toc-text">3.3 基本操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-1-%E5%AD%98%E5%82%A8%E6%A1%B6%E6%93%8D%E4%BD%9C"><span class="toc-text">3.3.1 存储桶操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-2-%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6"><span class="toc-text">3.3.2 上传文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-3-%E4%B8%8B%E8%BD%BD%E6%96%87%E4%BB%B6"><span class="toc-text">3.3.3 下载文件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%A1%88%E4%BE%8B"><span class="toc-text">3.4 上传图片案例</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/29/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/%E5%9F%BA%E7%A1%80%E5%8E%9F%E7%90%86/13_%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0_%E6%A6%82%E7%8E%87%E5%9B%BE%E6%A8%A1%E5%9E%8B/" title="13_机器学习_概率图模型">13_机器学习_概率图模型</a><time datetime="2025-07-29T00:29:02.000Z" title="发表于 2025-07-29 08:29:02">2025-07-29</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/28/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/%E5%9F%BA%E7%A1%80%E5%8E%9F%E7%90%86/11_%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0_%E8%81%9A%E7%B1%BB/" title="11_机器学习_聚类">11_机器学习_聚类</a><time datetime="2025-07-28T00:19:53.000Z" title="发表于 2025-07-28 08:19:53">2025-07-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/28/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/%E5%9F%BA%E7%A1%80%E5%8E%9F%E7%90%86/12_%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0_%E9%99%8D%E7%BB%B4/" title="12_机器学习_降维">12_机器学习_降维</a><time datetime="2025-07-27T20:48:42.000Z" title="发表于 2025-07-28 04:48:42">2025-07-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/26/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/%E5%9F%BA%E7%A1%80%E5%8E%9F%E7%90%86/10_%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0_%E9%9B%86%E6%88%90%E5%AD%A6%E4%B9%A0/" title="10_机器学习_集成学习">10_机器学习_集成学习</a><time datetime="2025-07-26T01:58:53.000Z" title="发表于 2025-07-26 09:58:53">2025-07-26</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/25/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/%E5%9F%BA%E7%A1%80%E5%8E%9F%E7%90%86/09_%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0_%E6%9C%B4%E7%B4%A0%E8%B4%9D%E5%8F%B6%E6%96%AF/" title="09_机器学习_朴素贝叶斯">09_机器学习_朴素贝叶斯</a><time datetime="2025-07-25T03:08:47.000Z" title="发表于 2025-07-25 11:08:47">2025-07-25</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/./img/1.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By Scenery</div><div class="footer_custom_text"><div>波澜不惊</div><div class="footer-div"><img class="footer-icon" src="./img/备案图标.png"><a class="footer-a" target="_blank" rel="noopener" href="http://beian.miit.gov.cn/">皖ICP备2021016944号-1</a></div></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div></body></html>